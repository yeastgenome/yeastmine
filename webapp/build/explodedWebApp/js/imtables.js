// Generated by CoffeeScript 1.3.3

/*
 * InterMine Results Tables Library v0.0.1
 * http://www.intermine.org
 *
 * Copyright 2012, Alex Kalderimis
 * Released under the LGPL license.
 * 
 * Built at Wed Jun 27 2012 13:57:37 GMT+0100 (BST)
*/


(function() {
  var $, root, scope, stope,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  if (!Array.prototype.filter) {
    Array.prototype.filter = function(test) {
      var x, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = this.length; _i < _len; _i++) {
        x = this[_i];
        if (test(x)) {
          _results.push(x);
        }
      }
      return _results;
    };
  }

  if (!Array.prototype.map) {
    Array.prototype.map = function(transform) {
      var x, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = this.length; _i < _len; _i++) {
        x = this[_i];
        _results.push(transform(x));
      }
      return _results;
    };
  }

  $ = jQuery;

  root = typeof exports !== "undefined" && exports !== null ? exports : this;

  if (!root.console) {
    root.console = {
      log: function() {},
      debug: function() {},
      error: function() {}
    };
  }

  stope = function(f) {
    return function(e) {
      e.stopPropagation();
      e.preventDefault();
      return f(e);
    };
  };

  scope = function(path, code, overwrite) {
    var exporting, name, ns, part, parts, value, _i, _len;
    if (code == null) {
      code = (function() {});
    }
    if (overwrite == null) {
      overwrite = false;
    }
    parts = path.split(".");
    ns = root;
    for (_i = 0, _len = parts.length; _i < _len; _i++) {
      part = parts[_i];
      ns = ns[part] ? ns[part] : (ns[part] = {});
    }
    exporting = function(cls) {
      return ns[cls.name] = cls;
    };
    if (_.isFunction(code)) {
      code(exporting);
    } else {
      for (name in code) {
        value = code[name];
        ns[name] = value;
      }
    }
    return ns;
  };

  scope("intermine.query", function(exporting) {
    var Attribute, CONSTRAINT_ADDER_HTML, ConstraintAdder, PATH_HIGHLIGHTER, PATH_LEN_SORTER, PATH_MATCHER, PathChooser, Reference, pathLen, pos;
    pos = function(substr) {
      return _.memoize(function(str) {
        return str.toLowerCase().indexOf(substr);
      });
    };
    pathLen = _.memoize(function(str) {
      return str.split(".").length;
    });
    exporting(PATH_LEN_SORTER = function(items) {
      var getPos;
      getPos = pos(this.query.toLowerCase());
      items.sort(function(a, b) {
        if (a === b) {
          return 0;
        } else {
          return getPos(a) - getPos(b) || pathLen(a) - pathLen(b) || (a < b ? -1 : 1);
        }
      });
      return items;
    });
    exporting(PATH_MATCHER = function(item) {
      var lci, term, terms;
      lci = item.toLowerCase();
      terms = (function() {
        var _i, _len, _ref, _results;
        _ref = this.query.toLowerCase().split(/\s+/);
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          term = _ref[_i];
          if (term) {
            _results.push(term);
          }
        }
        return _results;
      }).call(this);
      return item && _.all(terms, function(t) {
        return lci.match(t);
      });
    });
    exporting(PATH_HIGHLIGHTER = function(item) {
      var term, terms, _i, _len;
      terms = this.query.toLowerCase().split(/\s+/);
      for (_i = 0, _len = terms.length; _i < _len; _i++) {
        term = terms[_i];
        if (term) {
          item = item.replace(new RegExp(term, "gi"), function(match) {
            return "<>" + match + "</>";
          });
        }
      }
      return item.replace(/>/g, "strong>");
    });
    CONSTRAINT_ADDER_HTML = "<input type=\"text\" placeholder=\"Add a new filter\" class=\"im-constraint-adder span9\">\n<button disabled class=\"btn span2\" type=\"submit\">\n    Filter\n</button>";
    Attribute = (function(_super) {

      __extends(Attribute, _super);

      function Attribute() {
        return Attribute.__super__.constructor.apply(this, arguments);
      }

      Attribute.prototype.tagName = 'li';

      Attribute.prototype.events = {
        'click a': 'handleClick'
      };

      Attribute.prototype.handleClick = function(e) {
        e.stopPropagation();
        e.preventDefault();
        return this.evts.trigger('chosen', this.path);
      };

      Attribute.prototype.initialize = function(query, path, depth, evts) {
        var _this = this;
        this.query = query;
        this.path = path;
        this.depth = depth;
        this.evts = evts;
        this.evts.on('remove', function() {
          return _this.remove();
        });
        return this.evts.on('filter:paths', function(terms) {
          var lastMatch, matches, t, _i, _len;
          terms = (function() {
            var _i, _len, _results;
            _results = [];
            for (_i = 0, _len = terms.length; _i < _len; _i++) {
              t = terms[_i];
              if (t) {
                _results.push(new RegExp(t, 'i'));
              }
            }
            return _results;
          })();
          if (terms.length) {
            matches = 0;
            lastMatch = null;
            for (_i = 0, _len = terms.length; _i < _len; _i++) {
              t = terms[_i];
              if (t.test(_this.path.toString()) || t.test(_this.displayName)) {
                matches += 1;
                lastMatch = t;
              }
            }
            return _this.matches(matches, terms, lastMatch);
          } else {
            return _this.$el.show();
          }
        });
      };

      Attribute.prototype.template = _.template("<a href=\"#\" title=\"<%- path %> (<%- type %>)\"><span><%- name %></span></a>");

      Attribute.prototype.matches = function(matches, terms) {
        var _this = this;
        if (matches === terms.length) {
          this.evts.trigger('matched', this.path.toString());
          this.path.getDisplayName(function(name) {
            var hl, matchesOnPath, term, _i, _len;
            hl = _this.depth > 0 ? name.replace(/^.*>\s*/, '') : name;
            for (_i = 0, _len = terms.length; _i < _len; _i++) {
              term = terms[_i];
              hl = hl.replace(term, function(match) {
                return "<strong>" + match + "</strong>";
              });
            }
            matchesOnPath = _.any(terms, function(t) {
              return !!_this.path.end.name.match(t);
            });
            return _this.$('a span').html(hl.match(/strong/) || !matchesOnPath ? hl : "<strong>" + hl + "</strong>");
          });
        }
        return this.$el.toggle(!!(matches === terms.length));
      };

      Attribute.prototype.render = function() {
        var disabled, _ref,
          _this = this;
        disabled = (_ref = this.path.toString(), __indexOf.call(this.query.views, _ref) >= 0);
        if (disabled) {
          this.$el.addClass('disabled');
        }
        this.path.getDisplayName(function(name) {
          var a;
          _this.displayName = name;
          if (_this.depth !== 0) {
            name = name.replace(/^.*\s*>/, '');
          }
          a = $(_this.template({
            name: name,
            path: _this.path,
            type: _this.path.getType()
          }));
          a.appendTo(_this.el);
          return _this.addedLiContent(a);
        });
        return this;
      };

      Attribute.prototype.addedLiContent = function(a) {
        return a.tooltip({
          placement: 'bottom'
        }).appendTo(this.el);
      };

      return Attribute;

    })(Backbone.View);
    Reference = (function(_super) {

      __extends(Reference, _super);

      function Reference() {
        return Reference.__super__.constructor.apply(this, arguments);
      }

      Reference.prototype.initialize = function(query, path, depth, evts) {
        var _this = this;
        this.query = query;
        this.path = path;
        this.depth = depth;
        this.evts = evts;
        Reference.__super__.initialize.call(this, this.query, this.path, this.depth, this.evts);
        this.evts.on('filter:paths', function(terms) {
          return _this.$el.hide();
        });
        return this.evts.on('matched', function(path) {
          if (path.match(_this.path.toString())) {
            _this.$el.show();
            if (!_this.$el.is('.open')) {
              return _this.openSubFinder();
            }
          }
        });
      };

      Reference.prototype.remove = function() {
        var _ref;
        if ((_ref = this.subfinder) != null) {
          _ref.remove();
        }
        return Reference.__super__.remove.call(this);
      };

      Reference.prototype.openSubFinder = function() {
        this.subfinder = new PathChooser(this.query, this.path, this.depth + 1, this.evts);
        this.$el.append(this.subfinder.render().el);
        return this.$el.addClass('open');
      };

      Reference.prototype.template = _.template("<a href=\"#\"><i class=\"icon-chevron-right\"></i> <span><%- name %></span></a>");

      Reference.prototype.iconClasses = "icon-chevron-right icon-chevron-down";

      Reference.prototype.addedLiContent = function(a) {
        var i,
          _this = this;
        if (_.any(this.query.views, function(v) {
          return v.match(_this.path.toString());
        })) {
          this.openSubFinder();
        }
        return i = a.find('i').click(function(e) {
          i.toggleClass(_this.iconClasses);
          if (_this.$el.is('.open')) {
            return _this.$el.removeClass('open').children('ul').remove();
          } else {
            return _this.openSubFinder();
          }
        });
      };

      return Reference;

    })(Attribute);
    PathChooser = (function(_super) {

      __extends(PathChooser, _super);

      function PathChooser() {
        this.searchFor = __bind(this.searchFor, this);
        return PathChooser.__super__.constructor.apply(this, arguments);
      }

      PathChooser.prototype.tagName = 'ul';

      PathChooser.prototype.dropDownClasses = 'typeahead dropdown-menu';

      PathChooser.prototype.searchFor = function(terms) {
        var m, matches, p, _i, _len, _results;
        this.evts.trigger('filter:paths', terms);
        matches = (function() {
          var _i, _len, _ref, _results,
            _this = this;
          _ref = this.query.getPossiblePaths(3);
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            p = _ref[_i];
            if (_.all(terms, function(t) {
              return p.match(new RegExp(t, 'i'));
            })) {
              _results.push(p);
            }
          }
          return _results;
        }).call(this);
        _results = [];
        for (_i = 0, _len = matches.length; _i < _len; _i++) {
          m = matches[_i];
          _results.push(this.evts.trigger('matched', m, terms));
        }
        return _results;
      };

      PathChooser.prototype.initialize = function(query, path, depth, events) {
        var attr, cd, coll, name, ref, toPath,
          _this = this;
        this.query = query;
        this.path = path;
        this.depth = depth;
        this.evts = this.depth === 0 ? _.extend({}, Backbone.Events) : events;
        cd = this.path.getEndClass();
        toPath = function(f) {
          return _this.path.append(f);
        };
        this.attributes = (function() {
          var _ref, _results;
          _ref = cd.attributes;
          _results = [];
          for (name in _ref) {
            attr = _ref[name];
            _results.push(toPath(attr));
          }
          return _results;
        })();
        this.references = (function() {
          var _ref, _results;
          _ref = cd.references;
          _results = [];
          for (name in _ref) {
            ref = _ref[name];
            _results.push(toPath(ref));
          }
          return _results;
        })();
        this.collections = (function() {
          var _ref, _results;
          _ref = cd.collections;
          _results = [];
          for (name in _ref) {
            coll = _ref[name];
            _results.push(toPath(coll));
          }
          return _results;
        })();
        if (this.depth === 0) {
          return this.evts.on('chosen', events);
        }
      };

      PathChooser.DIVIDER = "<li class=\"divider\"></li>";

      PathChooser.prototype.render = function() {
        var apath, cd, cpath, currentView, rpath, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2;
        cd = this.path.getEndClass();
        currentView = this.query.views;
        _ref = this.attributes;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          apath = _ref[_i];
          this.$el.append(new Attribute(this.query, apath, this.depth, this.evts).render().el);
        }
        this.$el.append(PathChooser.DIVIDER);
        _ref1 = this.references;
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          rpath = _ref1[_j];
          this.$el.append(new Reference(this.query, rpath, this.depth, this.evts).render().el);
        }
        _ref2 = this.collections;
        for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
          cpath = _ref2[_k];
          this.$el.append(new Reference(this.query, cpath, this.depth, this.evts).render().el);
        }
        if (this.depth === 0) {
          this.$el.addClass(this.dropDownClasses);
        }
        this.$el.show();
        return this;
      };

      return PathChooser;

    })(Backbone.View);
    return exporting(ConstraintAdder = (function(_super) {

      __extends(ConstraintAdder, _super);

      function ConstraintAdder() {
        this.filterOptions = __bind(this.filterOptions, this);

        this.showTree = __bind(this.showTree, this);

        this.handleChoice = __bind(this.handleChoice, this);
        return ConstraintAdder.__super__.constructor.apply(this, arguments);
      }

      ConstraintAdder.prototype.tagName = "form";

      ConstraintAdder.prototype.className = "form im-constraint-adder row-fluid im-constraint";

      ConstraintAdder.prototype.initialize = function(query) {
        var _this = this;
        this.query = query;
        return this.query.on("cancel:add-constraint", function() {
          _this.$('input').show();
          return _this.$('button[type="submit"]').show();
        });
      };

      ConstraintAdder.prototype.events = {
        'submit': 'handleSubmission'
      };

      ConstraintAdder.prototype.handleKeyup = function(e) {
        return $('.btn-primary').attr({
          disabled: false
        });
      };

      ConstraintAdder.prototype.leaveSearch = function(e) {
        var emptySearchBox;
        emptySearchBox = function() {
          $('input').val('');
          return $('.btn-primary').attr({
            disabled: true
          });
        };
        return _.delay(emptySearchBox, 7000);
      };

      ConstraintAdder.prototype.handleClick = function(e) {
        e.preventDefault();
        if (!$(e.target).is('button')) {
          e.stopPropagation();
        }
        if ($(e.target).is('button[type="submit"]')) {
          return this.handleSubmission(e);
        }
      };

      ConstraintAdder.prototype.handleSubmission = function(e) {
        var ac, con;
        e.preventDefault();
        e.stopPropagation();
        this.$('input').hide();
        this.$('button[type="submit"]').hide();
        con = {
          path: this.$('input').val()
        };
        ac = new intermine.query.NewConstraint(this.query, con);
        return ac.render().$el.appendTo(this.el);
      };

      ConstraintAdder.prototype.handleChoice = function(path) {
        this.$('input').val(path.toString());
        return this.$('.btn-primary').attr({
          disabled: false
        });
      };

      ConstraintAdder.prototype.showTree = function(e) {
        var pathFinder;
        e.stopPropagation();
        e.preventDefault();
        if (this.$pathfinder) {
          this.$pathfinder.remove();
          return this.$pathfinder = null;
        } else {
          root = this.query.getPathInfo(this.query.root);
          pathFinder = new PathChooser(this.query, root, 0, this.handleChoice);
          pathFinder.render().$el.appendTo(this.el).show();
          pathFinder.$el.css({
            top: this.$el.height()
          });
          return this.$pathfinder = pathFinder;
        }
      };

      ConstraintAdder.prototype.showOptions = function() {};

      ConstraintAdder.prototype.filterOptions = function(e) {
        var terms, thisTime, val, _ref, _ref1;
        if (this.filterLock) {
          return false;
        }
        this.filterLock = true;
        if (this.$pathfinder == null) {
          this.showTree(e);
        }
        val = (_ref = this.$('input').val()) != null ? _ref.replace(/\s+$/g, '').replace(/^\s+/g, '') : void 0;
        if (val != null) {
          this.$('.btn-primary').attr({
            disabled: false
          });
        }
        if ((val != null) && val.length >= 3) {
          thisTime = new Date().getTime();
          if ((!(this.lastSearch != null)) || ((this.lastSearch.time + 1000 < thisTime) && (this.lastSearch.term !== val))) {
            if (this.lastSearch != null) {
              this.$pathfinder.remove();
              this.$pathfinder = null;
              this.showTree(e);
            }
            console.log("Searching for " + val + " at " + thisTime);
            this.lastSearch = {
              time: thisTime,
              term: val
            };
            terms = (val != null ? val.split(/\s+/) : void 0) || [];
            if ((_ref1 = this.$pathfinder) != null) {
              _ref1.searchFor(terms);
            }
          } else {
            console.log("No search needed at " + thisTime);
          }
        }
        return this.filterLock = false;
      };

      ConstraintAdder.prototype.inputPlaceholder = "Add a column...";

      ConstraintAdder.prototype.render = function() {
        var approver, browser, input;
        input = this.make("input", {
          type: "text",
          placeholder: this.inputPlaceholder
        });
        this.$el.append(input);
        browser = $(this.make('button', {
          type: "button",
          "class": "btn"
        }, "Browse"));
        approver = $(this.make('button', {
          type: "button",
          "class": "btn btn-primary",
          disabled: true
        }, "Add"));
        this.$el.append(browser);
        this.$el.append(approver);
        approver.click(this.handleSubmission);
        browser.click(this.showTree);
        this.$('input').click(this.showOptions).keyup(this.filterOptions);
        return this;
      };

      return ConstraintAdder;

    })(Backbone.View));
  });

  scope("intermine.query.tools", function(exporting) {
    var PANE_HTML, TAB_HTML, ToolBar, Tools;
    TAB_HTML = _.template("<li>\n    <a href=\"#<%= ref %>\" data-toggle=\"tab\">\n        <%= title %>\n    </a>\n</li>");
    PANE_HTML = _.template("<div class=\"tab-pane\" id=\"<%= ref %>\"></div>");
    exporting(Tools = (function(_super) {

      __extends(Tools, _super);

      function Tools() {
        return Tools.__super__.constructor.apply(this, arguments);
      }

      Tools.prototype.className = "im-query-tools";

      Tools.prototype.initialize = function(query) {
        this.query = query;
      };

      Tools.prototype.render = function() {
        var $pane, actions, c, columns, conf, content, filters, tabs, view, _i, _j, _len, _len1;
        tabs = this.make("ul", {
          "class": "nav nav-tabs"
        });
        conf = [
          filters = {
            title: "Filters",
            ref: "filters",
            view: intermine.query.filters.Filters
          }, columns = {
            title: "Columns",
            ref: "columns",
            view: intermine.query.columns.Columns
          }, actions = {
            title: "Actions",
            ref: "actions",
            view: intermine.query.actions.Actions
          }
        ];
        for (_i = 0, _len = conf.length; _i < _len; _i++) {
          c = conf[_i];
          $(tabs).append(TAB_HTML(c));
        }
        this.$el.append(tabs);
        content = this.make("div", {
          "class": "tab-content"
        });
        for (_j = 0, _len1 = conf.length; _j < _len1; _j++) {
          c = conf[_j];
          $pane = $(PANE_HTML(c)).appendTo(content);
          view = new c.view(this.query);
          $pane.append(view.render().el);
        }
        $(content).find('.tab-pane').first().addClass("active");
        $(tabs).find("a").first().tab('show');
        this.$el.append(content);
        return this;
      };

      return Tools;

    })(Backbone.View));
    return exporting(ToolBar = (function(_super) {

      __extends(ToolBar, _super);

      function ToolBar() {
        return ToolBar.__super__.constructor.apply(this, arguments);
      }

      ToolBar.prototype.className = "im-query-actionbar row-fluid";

      ToolBar.prototype.initialize = function(query) {
        this.query = query;
      };

      ToolBar.prototype.render = function() {
        var actions;
        actions = new intermine.query.actions.ActionBar(this.query);
        actions.render().$el.appendTo(this.el);
        return this;
      };

      return ToolBar;

    })(Backbone.View));
  });

  scope("intermine.css", {
    headerIcon: "icon-white",
    headerIconRemove: "icon-remove-sign",
    headerIconHide: "icon-minus-sign",
    headerIconSummary: "icon-info-sign"
  });

  scope("intermine.query.results", function(exporting) {
    var COUNT_HTML, NUMERIC_TYPES, Page, ResultsTable, Table;
    NUMERIC_TYPES = ["int", "Integer", "double", "Double", "float", "Float"];
    COUNT_HTML = _.template("<span>Showing <%= first %> to <%= last %> of <%= count %></span> <%= roots %>");
    Page = (function() {

      function Page(start, size) {
        this.start = start;
        this.size = size;
      }

      Page.prototype.end = function() {
        return this.start + this.size;
      };

      return Page;

    })();
    ResultsTable = (function(_super) {

      __extends(ResultsTable, _super);

      function ResultsTable() {
        this.addColumnHeaders = __bind(this.addColumnHeaders, this);

        this.handleError = __bind(this.handleError, this);

        this.appendRows = __bind(this.appendRows, this);
        return ResultsTable.__super__.constructor.apply(this, arguments);
      }

      ResultsTable.nextDirections = {
        ASC: "DESC",
        DESC: "ASC"
      };

      ResultsTable.prototype.className = "im-results-table table table-striped table-bordered";

      ResultsTable.prototype.tagName = "table";

      ResultsTable.prototype.attributes = {
        width: "100%",
        cellpadding: 0,
        border: 0,
        cellspacing: 0
      };

      ResultsTable.prototype.pageSize = 25;

      ResultsTable.prototype.pageStart = 0;

      ResultsTable.prototype.pageSizes = [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]];

      ResultsTable.prototype.throbber = _.template("<tr class=\"im-table-throbber\">\n    <td colspan=\"<%= colcount %>\">\n        <h2>Requesting Data</h2>\n        <div class=\"progress progress-info progress-striped active\">\n            <div class=\"bar\" style=\"width: 100%\"></div>\n        </div>\n    </td>\n</tr>");

      ResultsTable.prototype.pageSizeTempl = _.template("<%= pageSize %> rows per page");

      ResultsTable.prototype.initialize = function(query, getData) {
        var _this = this;
        this.query = query;
        this.getData = getData;
        this.minimisedCols = {};
        return this.query.on("set:sortorder", function(oes) {
          _this.lastAction = 'resort';
          return _this.fill();
        });
      };

      ResultsTable.prototype.render = function() {
        var promise;
        this.$el.empty();
        promise = this.fill();
        return promise.done(this.addColumnHeaders);
      };

      ResultsTable.prototype.goTo = function(start) {
        this.pageStart = parseInt(start);
        return this.fill();
      };

      ResultsTable.prototype.goToPage = function(page) {
        this.pageStart = page * this.pageSize;
        return this.fill();
      };

      ResultsTable.prototype.fill = function() {
        var promise, throbber,
          _this = this;
        throbber = $(this.throbber({
          colcount: this.query.views.length
        }));
        promise = this.getData(this.pageStart, this.pageSize);
        promise.then(this.appendRows, this.handleError).always(function() {
          return throbber.remove();
        });
        promise.done(function() {
          return _this.query.trigger("imtable:change:page", _this.pageStart, _this.pageSize);
        });
        return promise;
      };

      ResultsTable.prototype.appendRows = function(res) {
        var row, _i, _len, _ref;
        this.$("tbody > tr").remove();
        _ref = res.rows;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          row = _ref[_i];
          this.appendRow(row);
        }
        return this.query.trigger("table:filled");
      };

      ResultsTable.prototype.minimisedColumnPlaceholder = _.template("<td class=\"im-minimised-col\" style=\"width:<%= width %>px\">&hellip;</td>");

      ResultsTable.prototype.appendRow = function(row) {
        var cell, i, k, minWidth, minimised, tr, v, w, _fn, _i, _len,
          _this = this;
        tr = $("<tr>");
        minWidth = 10;
        minimised = (function() {
          var _ref, _results;
          _ref = this.minimisedCols;
          _results = [];
          for (k in _ref) {
            v = _ref[k];
            if (v) {
              _results.push(k);
            }
          }
          return _results;
        }).call(this);
        w = 1 / (row.length - minimised.length) * (this.$el.width() - (minWidth * minimised.length));
        _fn = function(cell, i) {
          if (_this.minimisedCols[i]) {
            return tr.append(_this.minimisedColumnPlaceholder({
              width: minWidth
            }));
          } else {
            return tr.append(cell.render().setWidth(w).$el);
          }
        };
        for (i = _i = 0, _len = row.length; _i < _len; i = ++_i) {
          cell = row[i];
          _fn(cell, i);
        }
        return tr.appendTo(this.el);
      };

      ResultsTable.prototype.errorTempl = _.template("<div class=\"alert alert-error\">\n    <h2>Oops!</h2>\n    <p><i><%- error %></i></p>\n</div>");

      ResultsTable.prototype.handleError = function(err, time) {
        var btn, mailto, notice, p;
        notice = $(this.errorTempl({
          error: err
        }));
        if (time != null) {
          notice.append("<p>Time: " + time + "</p>");
        }
        notice.append("<p>\n    This is most likely related to the query that was just run. If you have\n    time, please send us an email with details of this query to help us diagnose and\n    fix this bug.\n</p>");
        btn = $('<button class="btn btn-error">');
        notice.append(btn);
        p = $('<p style="display:none" class="well">');
        btn.text('show query');
        p.text(this.query.toXML());
        btn.click(function() {
          return p.slideToggle();
        });
        mailto = this.query.service.help + "?" + $.param({
          subject: "Error running embedded table query",
          body: "We encountered an error running a query from an\nembedded result table.\n\npage:       " + window.location + "\nservice:    " + this.query.service.root + "\nerror:      " + err + "\ndate-stamp: " + time + "\nquery:      " + (this.query.toXML())
        }, true);
        mailto = mailto.replace(/\+/g, '%20');
        notice.append("<a class=\"btn btn-primary pull-right\" href=\"mailto:" + mailto + "\">\n    Email the help-desk\n</a>");
        notice.append(p);
        return this.$el.append(notice);
      };

      ResultsTable.prototype.columnHeaderTempl = function(ctx) {
        return _.template("<th title=\"<%- title %>\">\n    <div class=\"navbar\">\n        <div class=\"im-th-buttons\">\n            <% if (sortable) { %>\n                <div class=\"im-th-button im-col-sort-indicator\" title=\"sort this column\">\n                    <i class=\"icon-resize-vertical " + intermine.css.headerIcon + "\"></i>\n                </div>\n            <% }; %>\n            <div class=\"im-th-button im-col-remover\" title=\"remove this column\" data-view=\"<%= view %>\">\n                <i class=\"" + intermine.css.headerIconRemove + " " + intermine.css.headerIcon + "\"></i>\n            </div>\n            <div class=\"im-th-button im-col-minumaximiser\" title=\"Hide column\" data-col-idx=\"<%= i %>\">\n                <i class=\"" + intermine.css.headerIconHide + " " + intermine.css.headerIcon + "\"></i>\n            </div>\n            <div class=\"dropdown im-summary\">\n                <div class=\"im-th-button summary-img dropdown-toggle\" title=\"column summary\"\n                    data-toggle=\"dropdown\" data-col-idx=\"<%= i %>\" >\n                    <i class=\"" + intermine.css.headerIconSummary + " " + intermine.css.headerIcon + "\"></i>\n                </div>\n                <div class=\"dropdown-menu\">\n                    <div>Could not ititialise the column summary.</div>\n                </div>\n            </div>\n        </div>\n        <span class=\"im-col-title\"><%- title %></span>\n    </div>\n</th>", ctx);
      };

      ResultsTable.prototype.buildColumnHeader = function(view, i, title, tr) {
        var cmd, cmds, direction, expandAll, minumaximiser, path, q, setDirectionClass, sortButton, sortable, th,
          _this = this;
        q = this.query;
        direction = q.getSortDirection(view);
        sortable = !q.isOuterJoined(view);
        th = $(this.columnHeaderTempl({
          title: title,
          i: i,
          view: view,
          sortable: sortable
        }));
        tr.append(th);
        th.find('.im-th-button').tooltip({
          placement: "left"
        });
        sortButton = th.find('.icon-resize-vertical');
        setDirectionClass = function(d) {
          sortButton.addClass("icon-resize-vertical");
          sortButton.removeClass("icon-arrow-up icon-arrow-down");
          switch (d) {
            case 'ASC':
              return sortButton.toggleClass("icon-resize-vertical icon-arrow-up");
            case 'DESC':
              return sortButton.toggleClass("icon-resize-vertical icon-arrow-down");
          }
        };
        setDirectionClass(direction);
        this.query.on("set:sortorder", function() {
          var sd;
          sd = q.getSortDirection(view);
          if (sd) {
            return setDirectionClass(sd);
          }
        });
        direction = ResultsTable.nextDirections[direction] || "ASC";
        sortButton.click(function(e) {
          var $elem;
          $elem = $(this);
          q.orderBy([
            {
              path: view,
              direction: direction
            }
          ]);
          tr.find('.im-col-sort-indicator i').removeClass("icon-arrow-up icon-arrow-down");
          tr.find('.im-col-sort-indicator i').addClass("icon-resize-vertical");
          switch (direction) {
            case "ASC":
              sortButton.toggleClass("icon-resize-vertical icon-arrow-up");
              break;
            case "DESC":
              sortButton.toggleClass("icon-resize-vertical icon-arrow-down");
          }
          return direction = ResultsTable.nextDirections[direction];
        });
        minumaximiser = th.find('.im-col-minumaximiser');
        minumaximiser.click(function(e) {
          var isMinimised;
          minumaximiser.find('i').toggleClass("icon-minus-sign icon-plus-sign");
          isMinimised = _this.minimisedCols[i] = !_this.minimisedCols[i];
          th.find('.im-col-title').toggle(!isMinimised);
          return _this.fill();
        });
        path = q.getPathInfo(view);
        if (path.isAttribute()) {
          return th.find('.summary-img').click(this.showColumnSummary(path)).dropdown();
        } else {
          th.find('.summary-img').click(this.showOuterJoinedColumnSummaries(path)).dropdown();
          expandAll = $("<div class=\"im-th-button\" title=\"Expand/Collapse all subtables\">\n    <i class=\"icon-th-list icon-white\"></i>\n</div>");
          expandAll.tooltip({
            placement: 'left'
          });
          th.find('.im-th-buttons').prepend(expandAll);
          cmds = ['expand', 'collapse'];
          cmd = 0;
          this.query.on('subtable:expanded', function(node) {
            if (node.toString().match(path.toString())) {
              return cmd = 1;
            }
          });
          this.query.on('subtable:collapsed', function(node) {
            if (node.toString().match(path.toString())) {
              return cmd = 0;
            }
          });
          return expandAll.click(function(e) {
            e.stopPropagation();
            e.preventDefault();
            _this.query.trigger("" + cmds[cmd] + ":subtables", path);
            cmd = (cmd + 1) % 2;
            return console.log(cmd);
          });
        }
      };

      ResultsTable.prototype.addColumnHeaders = function(result) {
        var i, promise, q, thead, titles, tr, view, views, _fn, _i, _len,
          _this = this;
        thead = $("<thead>");
        tr = $("<tr>");
        thead.append(tr);
        q = this.query;
        if (result.results.length && _.has(result.results[0][0], 'column')) {
          views = result.results[0].map(function(row) {
            return row.column;
          });
          promise = new $.Deferred();
          titles = {};
          _.each(views, function(v) {
            return q.getPathInfo(v).getDisplayName(function(name) {
              titles[v] = name;
              if (_.size(titles) === views.length) {
                return promise.resolve(titles);
              }
            });
          });
          promise.done(function(titles) {
            var i, v, _i, _len, _results;
            _results = [];
            for (i = _i = 0, _len = views.length; _i < _len; i = ++_i) {
              v = views[i];
              _results.push(_this.buildColumnHeader(v, i, titles[v], tr));
            }
            return _results;
          });
        } else {
          views = q.views;
          _fn = function(view, i) {
            var title;
            title = result.columnHeaders[i].split(' > ').slice(1).join(" > ");
            return _this.buildColumnHeader(view, i, title, tr);
          };
          for (i = _i = 0, _len = views.length; _i < _len; i = ++_i) {
            view = views[i];
            _fn(view, i);
          }
        }
        return thead.appendTo(this.el);
      };

      ResultsTable.prototype.showOuterJoinedColumnSummaries = function(path) {
        var _this = this;
        return function(e) {
          var $el, summ;
          $el = jQuery(e.target).closest('.summary-img');
          if (!$el.parent().hasClass('open')) {
            summ = new intermine.query.results.OuterJoinDropDown(path, _this.query);
            $el.siblings('.dropdown-menu').html(summ.render().el);
          }
          return false;
        };
      };

      ResultsTable.prototype.showColumnSummary = function(path) {
        var _this = this;
        return function(e) {
          var $el, summ, view;
          $el = jQuery(e.target).closest('.summary-img');
          view = path.toString();
          if (!view) {
            e.stopPropagation();
            e.preventDefault();
          } else if (!$el.parent().hasClass("open")) {
            summ = new intermine.query.results.DropDownColumnSummary(view, _this.query);
            $el.siblings('.dropdown-menu').html(summ.render().el);
          }
          return false;
        };
      };

      return ResultsTable;

    })(Backbone.View);
    return exporting(Table = (function(_super) {

      __extends(Table, _super);

      function Table() {
        this.updatePageDisplay = __bind(this.updatePageDisplay, this);

        this.removeColumn = __bind(this.removeColumn, this);

        this.removeOverlay = __bind(this.removeOverlay, this);

        this.overlayTable = __bind(this.overlayTable, this);

        this.getRowData = __bind(this.getRowData, this);

        this.showError = __bind(this.showError, this);

        this.refresh = __bind(this.refresh, this);

        this.onDraw = __bind(this.onDraw, this);
        return Table.__super__.constructor.apply(this, arguments);
      }

      Table.prototype.className = "im-table-container";

      Table.prototype.paginationTempl = _.template("<div class=\"pagination pagination-right\">\n    <ul>\n        <li title=\"Go to start\">\n            <a class=\"im-pagination-button\" data-goto=start>&#x21e4;</a>\n        </li>\n        <li title=\"Go back five pages\">\n            <a class=\"im-pagination-button\" data-goto=fast-rewind>&#x219e;</a>\n        </li>\n        <li title=\"Go to previous page\">\n            <a class=\"im-pagination-button\" data-goto=prev>&larr;</a>\n        </li>\n        <li class=\"im-current-page\">\n            <a data-goto=here  href=\"#\">&hellip;</a>\n            <form style=\"display:none;\"><select></select></form>\n        </li>\n        <li title=\"Go to next page\">\n            <a class=\"im-pagination-button\" data-goto=next>&rarr;</a>\n        </li>\n        <li title=\"Go forward five pages\">\n            <a class=\"im-pagination-button\" data-goto=fast-forward>&#x21a0;</a>\n        </li>\n        <li title=\"Go to last page\">\n            <a class=\"im-pagination-button\" data-goto=end>&#x21e5;</a>\n        </li>\n    </ul>\n</div>");

      Table.prototype.onDraw = function() {
        if (this.__selecting) {
          this.query.trigger("start:list-creation");
        }
        return this.drawn = true;
      };

      Table.prototype.refresh = function() {
        var _ref;
        if ((_ref = this.table) != null) {
          _ref.remove();
        }
        this.drawn = false;
        return this.render();
      };

      Table.prototype.initialize = function(query, selector) {
        var _this = this;
        this.query = query;
        this.cache = {};
        this.itemModels = {};
        this._pipe_factor = 10;
        this.$parent = jQuery(selector);
        this.__selecting = false;
        this.visibleViews = this.query.views.slice();
        this.query.on("change:views", function() {
          _this.visibleViews = _this.query.views.slice();
          return _this.refresh();
        });
        this.query.on("start:list-creation", function() {
          return _this.__selecting = true;
        });
        this.query.on("stop:list-creation", function() {
          return _this.__selecting = false;
        });
        this.query.on("change:constraints", this.refresh);
        this.query.on("change:joins", this.refresh);
        return this.query.on("table:filled", this.onDraw);
      };

      Table.prototype.adjustSortOrder = function(params) {
        var i, noOfSortColumns, viewIndices;
        viewIndices = (function() {
          var _i, _ref, _results;
          _results = [];
          for (i = _i = 0, _ref = intermine.utils.getParameter(params, "iColumns"); 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
            _results.push(intermine.utils.getParameter(params, "mDataProp_" + i));
          }
          return _results;
        })();
        noOfSortColumns = intermine.utils.getParameter(params, "iSortingCols");
        if (noOfSortColumns) {
          return this.query.orderBy((function() {
            var _i, _results,
              _this = this;
            _results = [];
            for (i = _i = 0; 0 <= noOfSortColumns ? _i < noOfSortColumns : _i > noOfSortColumns; i = 0 <= noOfSortColumns ? ++_i : --_i) {
              _results.push((function(i) {
                var displayed, so;
                displayed = intermine.utils.getParameter(params, "iSortCol_" + i);
                so = {
                  path: _this.query.views[viewIndices[displayed]],
                  direction: intermine.utils.getParameter(params, "sSortDir_" + i)
                };
                return so;
              })(i));
            }
            return _results;
          }).call(this));
        }
      };

      Table.prototype.showError = function(resp) {
        var data, _ref, _ref1;
        try {
          data = JSON.parse(resp.responseText);
          return (_ref = this.table) != null ? _ref.handleError(data.error, data.executionTime) : void 0;
        } catch (err) {
          return (_ref1 = this.table) != null ? _ref1.handleError("Internal error", new Date().toString()) : void 0;
        }
      };

      Table.prototype.getRowData = function(start, size) {
        var end, freshness, isOutOfRange, isStale, page, promise, req,
          _this = this;
        end = start + size;
        isOutOfRange = false;
        freshness = this.query.getSorting() + this.query.getConstraintXML() + this.query.views.join();
        isStale = freshness !== this.cache.freshness;
        if (isStale) {
          this.cache = {};
        } else {
          isOutOfRange = this.cache.lowerBound < 0 || start < this.cache.lowerBound || end > this.cache.upperBound || size < 0;
        }
        promise = new jQuery.Deferred();
        if (isStale || isOutOfRange) {
          page = this.getPage(start, size);
          this.overlayTable();
          req = this.query[this.fetchMethod](page, function(rows, resultSet) {
            _this.addRowsToCache(page, resultSet);
            return _this.cache.freshness = freshness;
          });
          req.fail(this.showError);
          req.done(function() {
            return promise.resolve(_this.serveResultsFromCache(start, size));
          });
          req.always(this.removeOverlay);
        } else {
          promise.resolve(this.serveResultsFromCache(start, size));
        }
        return promise;
      };

      Table.prototype.overlayTable = function() {
        var elOffset, tableOffset,
          _this = this;
        if (!(this.table && this.drawn)) {
          return;
        }
        elOffset = this.$el.offset();
        tableOffset = this.table.$el.offset();
        jQuery('.im-table-overlay').remove();
        this.overlay = jQuery(this.make("div", {
          "class": "im-table-overlay discrete"
        }));
        this.overlay.css({
          top: elOffset.top,
          left: elOffset.left,
          width: this.table.$el.outerWidth(true),
          height: (tableOffset.top - elOffset.top) + this.table.$el.outerHeight()
        });
        this.overlay.append(this.make("h1", {}, "Requesting data..."));
        this.overlay.find("h1").css({
          top: (this.table.$el.height() / 2) + "px",
          left: (this.table.$el.width() / 4) + "px"
        });
        this.overlay.appendTo('body');
        return _.delay((function() {
          return _this.overlay.removeClass("discrete");
        }), 100);
      };

      Table.prototype.removeOverlay = function() {
        var _ref;
        return (_ref = this.overlay) != null ? _ref.remove() : void 0;
      };

      Table.prototype.getPage = function(start, size) {
        var page;
        page = new Page(start, size);
        if (!this.cache.lastResult) {
          page.size *= this._pipe_factor;
          return page;
        }
        if (start < this.cache.lowerBound) {
          page.start = Math.max(0, start - (size * this._pipe_factor));
        }
        if (size > 0) {
          page.size *= this._pipe_factor;
        } else {
          page.size = 0;
        }
        if (page.size && (page.end() < this.cache.lowerBound)) {
          if ((this.cache.lowerBound - page.end()) > (page.size * 10)) {
            this.cache = {};
            page.size *= 2;
            return page;
          } else {
            page.size = this.cache.lowerBound - page.start;
          }
        }
        if (this.cache.upperBound < page.start) {
          if ((page.start - this.cache.upperBound) > (page.size * 10)) {
            this.cache = {};
            page.size *= 2;
            page.start = Math.max(0, page.start - (size * this._pipe_factor));
            return page;
          }
          if (page.size !== 0) {
            page.size += page.start - this.cache.upperBound;
          }
          page.start = this.cache.upperBound;
        }
        return page;
      };

      Table.prototype.addRowsToCache = function(page, result) {
        var merged, rows;
        if (!this.cache.lastResult) {
          this.cache.lastResult = result;
          this.cache.lowerBound = result.start;
          return this.cache.upperBound = page.end();
        } else {
          rows = result.results;
          merged = this.cache.lastResult.results.slice();
          if (page.start < this.cache.lowerBound) {
            merged = rows.concat(merged.slice(page.end() - this.cache.lowerBound));
          }
          if (this.cache.upperBound < page.end()) {
            merged = merged.slice(0, page.start - this.cache.lowerBound).concat(rows);
          }
          this.cache.lowerBound = Math.min(this.cache.lowerBound, page.start);
          this.cache.upperBound = Math.max(this.cache.upperBound, page.end());
          return this.cache.lastResult.results = merged;
        }
      };

      Table.prototype.updateSummary = function(start, size, result) {
        var html, summary;
        summary = this.$('.im-table-summary');
        html = COUNT_HTML({
          first: start + 1,
          last: Math.min(start + size, result.iTotalRecords),
          count: intermine.utils.numToString(result.iTotalRecords, ",", 3),
          roots: "rows"
        });
        return summary.html(html);
      };

      Table.prototype.serveResultsFromCache = function(start, size) {
        var base, fields, makeCell, result, v,
          _this = this;
        base = this.query.service.root.replace(/\/service\/?$/, "");
        result = jQuery.extend(true, {}, this.cache.lastResult);
        result.results.splice(0, start - this.cache.lowerBound);
        result.results.splice(size, result.results.length);
        this.updateSummary(start, size, result);
        fields = (function() {
          var _i, _len, _ref, _results;
          _ref = result.views;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            v = _ref[_i];
            _results.push([this.query.getPathInfo(v).getParent(), v.replace(/^.*\./, "")]);
          }
          return _results;
        }).call(this);
        makeCell = function(obj) {
          var args, field, model, node, _base, _name;
          if (_.has(obj, 'rows')) {
            return new intermine.results.table.SubTable(_this.query, makeCell, obj);
          } else {
            node = _this.query.getPathInfo(obj.column).getParent();
            field = obj.column.replace(/^.*\./, '');
            model = obj.id != null ? (_base = _this.itemModels)[_name = obj.id] || (_base[_name] = new intermine.model.IMObject(_this.query, obj, field, base)) : !(obj["class"] != null) ? new intermine.model.NullObject(_this.query, field) : new intermine.model.FPObject(_this.query, obj, field, node.getType().name);
            model.merge(obj, field);
            args = {
              model: model,
              node: node,
              field: field
            };
            args.query = _this.query;
            return new intermine.results.table.Cell(args);
          }
        };
        result.rows = result.results.map(function(row) {
          return row.map(function(cell, idx) {
            var field, imo, _base, _name;
            if (_.has(cell, 'column')) {
              return makeCell(cell);
            } else if ((cell != null ? cell.id : void 0) != null) {
              field = fields[idx];
              imo = (_base = _this.itemModels)[_name = cell.id] || (_base[_name] = new intermine.model.IMObject(_this.query, cell, field[1], base));
              imo.merge(cell, field[1]);
              return new intermine.results.table.Cell({
                model: imo,
                node: field[0],
                field: field[1],
                query: _this.query
              });
            } else if ((cell != null ? cell.value : void 0) != null) {
              return new intermine.results.table.Cell({
                model: new intermine.model.FPObject(_this.query, cell, field[1]),
                query: _this.query,
                field: field[1]
              });
            } else {
              return new intermine.results.table.NullCell({
                query: _this.query
              });
            }
          });
        });
        return result;
      };

      Table.prototype.tableAttrs = {
        "class": "table table-striped table-bordered",
        width: "100%",
        cellpadding: 0,
        border: 0,
        cellspacing: 0
      };

      Table.prototype.render = function() {
        var tel;
        this.$el.empty();
        this.$el.append("<div class=\"im-table-summary\"></div>");
        tel = this.make("table", this.tableAttrs);
        this.$el.append(tel);
        jQuery(tel).append("<h2>Building table</h2>\n<div class=\"progress progress-striped active progress-info\">\n    <div class=\"bar\" style=\"width: 100%\"></div>\n</div>");
        return this.query.service.fetchVersion(this.doRender(tel)).fail(this.onSetupError(tel));
      };

      Table.prototype.doRender = function(tel) {
        var _this = this;
        return function(version) {
          var path, setupParams;
          _this.fetchMethod = version >= 10 ? 'tableRows' : 'table';
          path = "query/results";
          setupParams = {
            format: "jsontable",
            query: _this.query.toXML(),
            token: _this.query.service.token
          };
          _this.$el.appendTo(_this.$parent);
          _this.query.service.makeRequest(path, setupParams, _this.onSetupSuccess(tel), "POST").fail(_this.onSetupError(tel));
          return _this;
        };
      };

      Table.prototype.events = {
        'click .im-col-remover': 'removeColumn'
      };

      Table.prototype.removeColumn = function(e) {
        var $el, unwanted, v, view;
        e.stopPropagation();
        e.preventDefault();
        $el = jQuery(e.target).closest('.im-col-remover');
        $el.tooltip("hide");
        view = $el.data("view");
        unwanted = (function() {
          var _i, _len, _ref, _results;
          _ref = this.query.views;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            v = _ref[_i];
            if (v.match(view)) {
              _results.push(v);
            }
          }
          return _results;
        }).call(this);
        this.query.removeFromSelect(unwanted);
        return false;
      };

      Table.prototype.horizontalScroller = "<div class=\"scroll-bar-wrap well\">\n    <div class=\"scroll-bar-containment\">\n        <div class=\"scroll-bar alert-info alert\"></div>\n    </div>\n</div>";

      Table.prototype.onSetupSuccess = function(telem) {
        var _this = this;
        return function(result) {
          var $pagination, $scrollwrapper, $telem, currentPageButton, currentPos, pageSelector, reorderer, scrollbar;
          $telem = jQuery(telem).empty();
          reorderer = new intermine.query.results.table.ColumnOrderer(_this.query);
          reorderer.render().$el.insertBefore(telem);
          $pagination = $(_this.paginationTempl()).insertBefore(telem);
          $pagination.find('li').tooltip({
            placement: "left"
          });
          pageSelector = $pagination.find('select').change(function() {
            _this.table.goToPage(pageSelector.val());
            currentPageButton.show();
            return pageSelector.parent().hide();
          });
          currentPageButton = $pagination.find(".im-current-page a").click(function() {
            var total;
            total = _this.cache.lastResult.iTotalRecords;
            if (_this.table.pageSize >= total) {
              return false;
            }
            currentPageButton.hide();
            return pageSelector.parent().show();
          });
          if (_this.bar === 'horizontal') {
            $scrollwrapper = $(_this.horizontalScroller).insertBefore(telem);
            scrollbar = _this.$('.scroll-bar');
            currentPos = 0;
            scrollbar.draggable({
              axis: "x",
              containment: "parent",
              stop: function(event, ui) {
                scrollbar.removeClass("scrolling");
                scrollbar.tooltip("hide");
                return _this.table.goTo(currentPos);
              },
              start: function() {
                return $(this).addClass("scrolling");
              },
              drag: function(event, ui) {
                var left, total;
                scrollbar.tooltip("show");
                left = ui.position.left;
                total = ui.helper.closest('.scroll-bar-wrap').width();
                return currentPos = _this.cache.lastResult.iTotalRecords * left / total;
              }
            });
            scrollbar.css({
              position: "absolute"
            }).parent().css({
              position: "relative"
            });
            scrollbar.tooltip({
              trigger: "manual",
              title: function() {
                return "" + ((currentPos + 1).toFixed()) + " ... " + ((currentPos + _this.table.pageSize).toFixed());
              }
            });
          }
          _this.table = new ResultsTable(_this.query, _this.getRowData);
          _this.table.setElement(telem);
          if (_this.pageSize != null) {
            _this.table.pageSize = _this.pageSize;
          }
          if (_this.pageStart != null) {
            _this.table.pageStart = _this.pageStart;
          }
          _this.table.render();
          return _this.query.on("imtable:change:page", _this.updatePageDisplay);
        };
      };

      Table.prototype.updatePageDisplay = function(start, size) {
        var buttons, centre, handle, maxPage, overhang, p, pageForm, pageSelector, proportion, scaled, scrollbar, tbl, total, totalWidth, unit, _i;
        total = this.cache.lastResult.iTotalRecords;
        scrollbar = this.$('.scroll-bar-wrap');
        if (scrollbar.length) {
          totalWidth = scrollbar.width();
          proportion = size / total;
          scrollbar.toggle(size < total);
          unit = totalWidth / total;
          scaled = Math.max(totalWidth * proportion, 20);
          overhang = size - ((total - (size * Math.floor(total / size))) % size);
          scrollbar.find('.scroll-bar-containment').css({
            width: totalWidth + (unit * overhang)
          });
          handle = scrollbar.find('.scroll-bar').css({
            width: scaled
          });
          handle.animate({
            left: unit * start
          });
        }
        tbl = this.table;
        buttons = this.$('.im-pagination-button');
        buttons.filter('.direct').remove();
        buttons.unbind("click").each(function() {
          var $elem, whenEnabled;
          $elem = $(this);
          whenEnabled = function(f) {
            return function() {
              if (!$elem.parent().is('.active')) {
                return f();
              }
            };
          };
          switch ($elem.data("goto")) {
            case "start":
              $elem.click(whenEnabled(function() {
                return tbl.goTo(0);
              }));
              return $elem.parent().toggleClass("active", start === 0);
            case "prev":
              $elem.click(whenEnabled(function() {
                return tbl.goTo(Math.max(0, start - size));
              }));
              return $elem.parent().toggleClass("active", start === 0);
            case "fast-rewind":
              $elem.click(whenEnabled(function() {
                return tbl.goTo(Math.max(0, start - (5 * size)));
              }));
              return $elem.parent().toggleClass("active", start === 0);
            case "next":
              $elem.click(whenEnabled(function() {
                return tbl.goTo(start + size);
              }));
              return $elem.parent().toggleClass("active", start + size >= total);
            case "fast-forward":
              $elem.click(whenEnabled(function() {
                return tbl.goTo(start + (5 * size));
              }));
              return $elem.parent().toggleClass("active", start + (5 * size) >= total);
            case "end":
              $elem.click(whenEnabled(function() {
                return tbl.goTo(Math.floor(total / size) * size);
              }));
              return $elem.parent().toggleClass("active", start + size >= total);
          }
        });
        centre = this.$('.im-current-page');
        centre.find('a').text("p. " + (Math.floor(start / size) + 1));
        centre.toggleClass("active", size >= total);
        pageForm = centre.find('form');
        pageForm.find('input').remove();
        pageSelector = pageForm.find('select').empty();
        maxPage = Math.floor(total / size);
        pageSelector.val(Math.floor(start / size));
        if (maxPage <= 100) {
          for (p = _i = 0; 0 <= maxPage ? _i <= maxPage : _i >= maxPage; p = 0 <= maxPage ? ++_i : --_i) {
            pageSelector.append("<option value=\"" + p + "\">p. " + (p + 1) + "</option>");
          }
          return pageSelector.show();
        } else {
          pageSelector.hide();
          return $("<input type=text placeholder=\"go to page...\">").appendTo(pageForm).change(function() {
            var newSelectorVal;
            newSelectorVal = parseInt($(this).val().replace(/\s*/g, "")) - 1;
            pageSelector.val(newSelectorVal).change();
            return $(this).remove();
          });
        }
      };

      Table.prototype.onSetupError = function(telem) {
        var _this = this;
        return function(xhr) {
          var explanation, issue, notice, part, parts;
          $(telem).empty();
          console.log("SETUP FAILURE", arguments);
          notice = _this.make("div", {
            "class": "alert alert-error"
          });
          explanation = "Could not load the data-table. The server may be down, or \nincorrectly configured, or we could be pointed at an invalid URL.";
          if (xhr != null ? xhr.responseText : void 0) {
            explanation = (typeof JSON !== "undefined" && JSON !== null ? JSON.parse(xhr.responseText).error : void 0) || explanation;
            parts = _((function() {
              var _i, _len, _ref, _results;
              _ref = explanation.split("\n");
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                part = _ref[_i];
                if (part != null) {
                  _results.push(part);
                }
              }
              return _results;
            })()).groupBy(function(p, i) {
              return i > 0;
            });
            explanation = [
              _this.make("span", {}, parts[false] + ""), _this.make("ul", {}, (function() {
                var _i, _len, _ref, _results;
                _ref = parts[true];
                _results = [];
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                  issue = _ref[_i];
                  _results.push(this.make("li", {}, issue));
                }
                return _results;
              }).call(_this))
            ];
          }
          return $(notice).append(_this.make("a", {
            "class": "close",
            "data-dismiss": "alert"
          }, "close")).append(_this.make("strong", {}, "Ooops...! ")).append(explanation).appendTo(telem);
        };
      };

      return Table;

    })(Backbone.View));
  });

  scope("intermine.query.results", function(exporting) {
    var DropDownColumnSummary, OuterJoinDropDown, SummaryHeading;
    exporting(OuterJoinDropDown = (function(_super) {

      __extends(OuterJoinDropDown, _super);

      function OuterJoinDropDown() {
        return OuterJoinDropDown.__super__.constructor.apply(this, arguments);
      }

      OuterJoinDropDown.prototype.className = "im-summary-selector";

      OuterJoinDropDown.prototype.tagName = 'ul';

      OuterJoinDropDown.prototype.initialize = function(path, query) {
        this.path = path;
        this.query = query;
      };

      OuterJoinDropDown.prototype.render = function() {
        var v, _i, _len, _ref,
          _this = this;
        console.log(this.path);
        _ref = this.query.views;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          v = _ref[_i];
          if (v.match(this.path.toString())) {
            (function(v) {
              var li;
              console.log("" + v + ".match(" + (_this.path.toString()) + ") -> " + (v.match(_this.path.toString())));
              li = $("<li class=\"im-outer-joined-path\"><a href=\"#\"></a></li>");
              _this.$el.append(li);
              _this.query.getPathInfo(v).getDisplayName(function(name) {
                return li.find('a').text(name);
              });
              return li.click(function(e) {
                var summ;
                e.stopPropagation();
                e.preventDefault();
                summ = new intermine.query.results.DropDownColumnSummary(v, _this.query);
                _this.$el.parent().html(summ.render().el);
                return _this.remove();
              });
            })(v);
          }
        }
        return this;
      };

      return OuterJoinDropDown;

    })(Backbone.View));
    exporting(DropDownColumnSummary = (function(_super) {

      __extends(DropDownColumnSummary, _super);

      function DropDownColumnSummary() {
        return DropDownColumnSummary.__super__.constructor.apply(this, arguments);
      }

      DropDownColumnSummary.prototype.className = "im-dropdown-summary";

      DropDownColumnSummary.prototype.initialize = function(view, query) {
        this.view = view;
        this.query = query;
      };

      DropDownColumnSummary.prototype.render = function() {
        var cons, heading, summ;
        heading = new SummaryHeading(this.query, this.view);
        heading.render().$el.appendTo(this.el);
        cons = new intermine.query.filters.SingleColumnConstraints(this.query, this.view);
        cons.render().$el.appendTo(this.el);
        summ = new intermine.results.ColumnSummary(this.view, this.query);
        summ.noTitle = true;
        summ.render().$el.appendTo(this.el);
        return this;
      };

      return DropDownColumnSummary;

    })(Backbone.View));
    return SummaryHeading = (function(_super) {

      __extends(SummaryHeading, _super);

      function SummaryHeading() {
        return SummaryHeading.__super__.constructor.apply(this, arguments);
      }

      SummaryHeading.prototype.initialize = function(query, view) {
        var _this = this;
        this.query = query;
        this.view = view;
        return this.query.on("got:summary:total", function(path, total, got, filteredTotal) {
          var available, nts;
          if (path === _this.view) {
            nts = function(num) {
              return intermine.utils.numToString(num, ',', 3);
            };
            available = filteredTotal != null ? filteredTotal : total;
            _this.$('.im-item-available').text(nts(available));
            _this.$('.im-item-got').text(got === available ? 'All' : "" + (nts(got)) + " of");
            return _this.$('.im-item-total').text(filteredTotal != null ? "(filtered from " + (nts(total)) + ")" : "");
          }
        });
      };

      SummaryHeading.prototype.template = _.template("<h3>\n    <span class=\"im-item-got\"></span>\n    <span class=\"im-item-available\"></span>\n    <span class=\"im-type-name\"></span>\n    <span class=\"im-attr-name\"></span>\n    <span class=\"im-item-total\"></span>\n</h3>");

      SummaryHeading.prototype.render = function() {
        var attr, s, type,
          _this = this;
        this.$el.append(this.template());
        s = this.query.service;
        type = this.query.getPathInfo(this.view).getParent().getType().name;
        attr = this.query.getPathInfo(this.view).end.name;
        s.makeRequest("model/" + type, {}, function(info) {
          return _this.$('.im-type-name').text(info.name);
        });
        s.makeRequest("model/" + type + "/" + attr, {}, function(info) {
          return _this.$('.im-attr-name').text(intermine.utils.pluralise(info.name));
        });
        return this;
      };

      return SummaryHeading;

    })(Backbone.View);
  });

  scope("intermine.query.filters", function(exporting) {
    var Constraints, FACETS, Facets, Filters, SingleColumnConstraints, SingleConstraintAdder;
    exporting(Filters = (function(_super) {

      __extends(Filters, _super);

      function Filters() {
        return Filters.__super__.constructor.apply(this, arguments);
      }

      Filters.prototype.className = "im-query-filters";

      Filters.prototype.initialize = function(query) {
        this.query = query;
      };

      Filters.prototype.render = function() {
        var constraints, facets;
        constraints = new Constraints(this.query);
        constraints.render().$el.appendTo(this.el);
        facets = new Facets(this.query);
        facets.render().$el.appendTo(this.el);
        return this;
      };

      return Filters;

    })(Backbone.View));
    FACETS = {
      Gene: [
        {
          title: "Pathways",
          path: "pathways.name"
        }, {
          title: "Expression Term",
          path: "mRNAExpressionResults.mRNAExpressionTerms.name"
        }, {
          title: "Ontology Term",
          path: "ontologyAnnotations.ontologyTerm.name"
        }, {
          title: "Protein Domains",
          path: "proteins.proteinDomains.name"
        }
      ]
    };
    Facets = (function(_super) {

      __extends(Facets, _super);

      function Facets() {
        this.render = __bind(this.render, this);
        return Facets.__super__.constructor.apply(this, arguments);
      }

      Facets.prototype.className = "im-query-facets";

      Facets.prototype.tagName = "dl";

      Facets.prototype.initialize = function(query) {
        this.query = query;
        this.query.on("change:constraints", this.render);
        return this.query.on("change:joins", this.render);
      };

      Facets.prototype.render = function() {
        var cs, f, facets, searcher, simplify, v, _i, _len,
          _this = this;
        this.$el.empty();
        simplify = function(x) {
          return x.replace(/^[^\.]+\./, "").replace(/\./g, " > ");
        };
        facets = (FACETS[this.query.root] || []).concat((function() {
          var _i, _len, _ref, _results;
          _ref = this.query.views;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            v = _ref[_i];
            _results.push({
              title: simplify(v),
              path: v
            });
          }
          return _results;
        }).call(this));
        if (facets) {
          searcher = this.make("input", {
            "class": "input-long",
            placeholder: "Filter facets..."
          });
          $(searcher).appendTo(this.el).keyup(function(e) {
            var pattern;
            pattern = new RegExp($(e.target).val(), "i");
            return _this.query.trigger("filter:facets", pattern);
          });
          for (_i = 0, _len = facets.length; _i < _len; _i++) {
            f = facets[_i];
            cs = new intermine.results.ColumnSummary(f, this.query);
            this.$el.append(cs.el);
            cs.render();
          }
        }
        return this;
      };

      return Facets;

    })(Backbone.View);
    Constraints = (function(_super) {

      __extends(Constraints, _super);

      function Constraints() {
        this.render = __bind(this.render, this);
        return Constraints.__super__.constructor.apply(this, arguments);
      }

      Constraints.prototype.className = "alert alert-info im-constraints";

      Constraints.prototype.initialize = function(query) {
        this.query = query;
        return this.query.on("change:constraints", this.render);
      };

      Constraints.prototype.getConstraints = function() {
        return this.query.constraints;
      };

      Constraints.prototype.getConAdder = function() {
        return new intermine.query.ConstraintAdder(this.query);
      };

      Constraints.prototype.render = function() {
        var c, cons, ul, _fn, _i, _len,
          _this = this;
        cons = this.getConstraints();
        this.$el.empty();
        this.$el.append(this.make("h3", {}, "Active Filters")).append(this.make("p", {}, cons.length ? "edit or remove the currently active filters" : "No filters")).append(ul = this.make("ul", {}));
        _fn = function(c) {
          var con;
          con = new intermine.query.ActiveConstraint(_this.query, c);
          return con.render().$el.appendTo($(ul));
        };
        for (_i = 0, _len = cons.length; _i < _len; _i++) {
          c = cons[_i];
          _fn(c);
        }
        this.getConAdder().render().$el.appendTo(this.el);
        return this;
      };

      Constraints.prototype.events = {
        click: function(e) {
          return e.stopPropagation();
        }
      };

      return Constraints;

    })(Backbone.View);
    SingleConstraintAdder = (function(_super) {

      __extends(SingleConstraintAdder, _super);

      function SingleConstraintAdder() {
        return SingleConstraintAdder.__super__.constructor.apply(this, arguments);
      }

      SingleConstraintAdder.prototype.initialize = function(query, view) {
        this.view = view;
        return SingleConstraintAdder.__super__.initialize.call(this, query);
      };

      SingleConstraintAdder.prototype.initPaths = function() {
        return [this.view];
      };

      SingleConstraintAdder.prototype.render = function() {
        SingleConstraintAdder.__super__.render.call(this);
        this.$('input').remove();
        this.$('button[type=submit]').attr({
          disabled: false
        });
        this.$el.append("<input type=\"hidden\" value=\"" + this.view + "\">");
        return this;
      };

      return SingleConstraintAdder;

    })(intermine.query.ConstraintAdder);
    return exporting(SingleColumnConstraints = (function(_super) {

      __extends(SingleColumnConstraints, _super);

      function SingleColumnConstraints() {
        return SingleColumnConstraints.__super__.constructor.apply(this, arguments);
      }

      SingleColumnConstraints.prototype.initialize = function(query, view) {
        this.view = view;
        return SingleColumnConstraints.__super__.initialize.call(this, query);
      };

      SingleColumnConstraints.prototype.getConAdder = function() {
        return new SingleConstraintAdder(this.query, this.view);
      };

      SingleColumnConstraints.prototype.getConstraints = function() {
        var c, _i, _len, _ref, _results;
        _ref = this.query.constraints;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          if (c.path === this.view) {
            _results.push(c);
          }
        }
        return _results;
      };

      SingleColumnConstraints.prototype.render = function() {
        var cons;
        SingleColumnConstraints.__super__.render.call(this);
        cons = this.getConstraints();
        if (cons.length < 1) {
          this.undelegateEvents();
          this.$el.hide();
        }
        return this;
      };

      return SingleColumnConstraints;

    })(Constraints));
  });

  scope("intermine.query.columns", function(exporting) {
    var ATTR_HTML, ColumnAdder, Columns, CurrentColumns, JOIN_TOGGLE_HTML, Selectable;
    exporting(Columns = (function(_super) {

      __extends(Columns, _super);

      function Columns() {
        return Columns.__super__.constructor.apply(this, arguments);
      }

      Columns.prototype.className = "im-query-columns";

      Columns.prototype.initialize = function(query) {
        this.query = query;
      };

      Columns.prototype.render = function() {
        var cls, _fn, _i, _len, _ref,
          _this = this;
        _ref = [ColumnAdder, CurrentColumns];
        _fn = function(cls) {
          var inst;
          inst = new cls(_this.query);
          return _this.$el.append(inst.render().el);
        };
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          cls = _ref[_i];
          _fn(cls);
        }
        return this;
      };

      return Columns;

    })(Backbone.View));
    CurrentColumns = (function(_super) {

      __extends(CurrentColumns, _super);

      function CurrentColumns() {
        return CurrentColumns.__super__.constructor.apply(this, arguments);
      }

      CurrentColumns.prototype.className = "node-remover";

      CurrentColumns.prototype.tagName = "dl";

      CurrentColumns.prototype.initialize = function(query) {
        this.query = query;
      };

      CurrentColumns.prototype.render = function() {
        var cd, rootSel, subnodes,
          _this = this;
        cd = this.query.service.model.classes[this.query.root];
        rootSel = new Selectable(this.query, cd);
        rootSel.render().$el.appendTo(this.el);
        subnodes = _({}).extend(cd.references, cd.collections);
        _(subnodes).chain().values().sortBy(function(f) {
          return f.name;
        }).each(function(f) {
          var sel, type;
          type = _this.query.getPathInfo(f).getEndClass();
          sel = new Selectable(_this.query, type, f);
          return sel.render().$el.appendTo(_this.el);
        });
        return this;
      };

      return CurrentColumns;

    })(Backbone.View);
    exporting(ColumnAdder = (function(_super) {

      __extends(ColumnAdder, _super);

      function ColumnAdder() {
        this.handleSubmission = __bind(this.handleSubmission, this);
        return ColumnAdder.__super__.constructor.apply(this, arguments);
      }

      ColumnAdder.prototype.className = "form node-adder input-append";

      ColumnAdder.prototype.handleSubmission = function(e) {
        var newPath;
        e.preventDefault();
        e.stopPropagation();
        newPath = this.$('input').val();
        return this.query.addToSelect(newPath);
      };

      return ColumnAdder;

    })(intermine.query.ConstraintAdder));
    JOIN_TOGGLE_HTML = _.template("<form class=\"form-inline pull-right im-join\">\n<div class=\"btn-group\" data-toggle=\"buttons-radio\">\n    <button data-style=\"INNER\" class=\"btn btn-small <% print(outer ? \"\" : \"active\") %>\">\n    Required\n    </button>\n    <button data-style=\"OUTER\" class=\"btn btn-small <% print(outer ? \"active\" : \"\") %>\">\n    Optional\n    </button>\n</div></form>");
    ATTR_HTML = _.template("<input type=\"checkbox\" \n    data-path=\"<%= path %>\"\n    <% inQuery ? print(\"checked\") : \"\" %> >\n<span class=\"im-view-option\">\n    <%= name %> (<% print(type.replace(\"java.lang.\", \"\")) %>)\n</span>");
    return Selectable = (function(_super) {

      __extends(Selectable, _super);

      function Selectable() {
        this.render = __bind(this.render, this);

        this.setCheckBoxState = __bind(this.setCheckBoxState, this);
        return Selectable.__super__.constructor.apply(this, arguments);
      }

      Selectable.prototype.tagName = "dl";

      Selectable.prototype.className = "im-selectable-node";

      Selectable.prototype.initialize = function(query, table, field) {
        this.query = query;
        this.table = table;
        this.field = field;
        this.path = this.query.root + (this.field ? "." + this.field.name : "");
        return this.query.on("change:views", this.setCheckBoxState);
      };

      Selectable.prototype.events = {
        'click dt': 'toggleFields',
        'change input[type="checkbox"]': 'changeView'
      };

      Selectable.prototype.toggleFields = function(e) {
        return this.$('dd').slideToggle();
      };

      Selectable.prototype.changeView = function(e) {
        var $t, path;
        $t = $(e.target);
        path = $t.data("path");
        if ($t.attr("checked")) {
          return this.query.addToSelect(path);
        } else {
          return this.query.removeFromSelect(path);
        }
      };

      Selectable.prototype.setCheckBoxState = function(e) {
        var _this = this;
        return this.$('dd input').each(function(i, cbx) {
          var $cbx, path;
          $cbx = $(cbx);
          path = $cbx.data("path");
          return $cbx.attr({
            checked: _this.query.hasView(path)
          });
        });
      };

      Selectable.prototype.render = function() {
        var attr, dt, icon, isInView, name, title, _fn, _ref, _ref1,
          _this = this;
        this.$el.empty();
        title = this.make("h4", {}, ((_ref = this.field) != null ? _ref.name : void 0) || this.table.name);
        dt = this.make("dt", {
          "class": "im-column-group"
        }, title);
        this.$el.append(dt);
        isInView = _(this.query.views).any(function(v) {
          return this.path === v.substring(0, v.lastIndexOf("."));
        });
        icon = isInView ? "minus" : "plus";
        $("<i class=\"icon-" + icon + "-sign\"></i>").css({
          cursor: "pointer"
        }).appendTo(title);
        if (isInView && this.path !== this.query.root) {
          $(JOIN_TOGGLE_HTML({
            outer: this.query.isOuterJoin(this.path)
          })).submit(function(e) {
            var _this = this;
            return e.preventDefault().css("display", "inline-block".appendTo(title.find(".btn".click(function(e) {
              var style;
              e.stopPropagation();
              style = $(e.target).data("style");
              return _this.query.setJoinStyle(_this.path, style.button());
            }))));
          });
        }
        _ref1 = this.table.attributes;
        _fn = function(attr) {
          return _this.addAttribute(attr);
        };
        for (name in _ref1) {
          attr = _ref1[name];
          _fn(attr);
        }
        return this;
      };

      Selectable.prototype.addAttribute = function(a) {
        var ctx, dd, p;
        if (a.name !== "id") {
          dd = this.make("dd");
          p = "" + this.path + "." + a.name;
          ctx = {
            path: p,
            inQuery: __indexOf.call(this.query.views, p) >= 0
          };
          _(ctx).extend(a);
          return $(dd).append(ATTR_HTML(ctx)).appendTo(this.el);
        }
      };

      return Selectable;

    })(Backbone.View);
  });

  scope("intermine.query.actions", function(exporting) {
    var ActionBar, Actions, CODE_GEN_LANGS, CodeGenerator, EXPORT_FORMATS, Exporters, ILLEGAL_LIST_NAME_CHARS, Item, ListAppender, ListCreator, ListDialogue, ListManager, UniqItems, openWindowWithPost;
    Item = (function(_super) {

      __extends(Item, _super);

      function Item() {
        return Item.__super__.constructor.apply(this, arguments);
      }

      Item.prototype.initialize = function(item) {
        return this.set("item", item);
      };

      return Item;

    })(Backbone.Model);
    UniqItems = (function(_super) {

      __extends(UniqItems, _super);

      function UniqItems() {
        return UniqItems.__super__.constructor.apply(this, arguments);
      }

      UniqItems.prototype.model = Item;

      UniqItems.prototype.add = function(items) {
        var item, _i, _len, _results;
        items = _(items).isArray() ? items : [items];
        _results = [];
        for (_i = 0, _len = items.length; _i < _len; _i++) {
          item = items[_i];
          if ((item != null) && "" !== item) {
            if (!(this.any(function(i) {
              return i.get("item") === item;
            }))) {
              _results.push(UniqItems.__super__.add.call(this, new Item(item)));
            } else {
              _results.push(void 0);
            }
          }
        }
        return _results;
      };

      UniqItems.prototype.remove = function(item) {
        var delenda;
        delenda = this.filter(function(i) {
          return i.get("item") === item;
        });
        return UniqItems.__super__.remove.call(this, delenda);
      };

      return UniqItems;

    })(Backbone.Collection);
    ILLEGAL_LIST_NAME_CHARS = /[^\w\s\(\):+\.-]/g;
    exporting(Actions = (function(_super) {

      __extends(Actions, _super);

      function Actions() {
        return Actions.__super__.constructor.apply(this, arguments);
      }

      Actions.prototype.className = "im-query-actions row-fluid";

      Actions.prototype.tagName = "ul";

      Actions.prototype.initialize = function(query) {
        this.query = query;
      };

      Actions.prototype.actionClasses = function() {
        return [ListManager, CodeGenerator, Exporters];
      };

      Actions.prototype.extraClass = "im-action";

      Actions.prototype.render = function() {
        var action, cls, _i, _len, _ref;
        _ref = this.actionClasses();
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          cls = _ref[_i];
          action = new cls(this.query);
          action.render().$el.addClass(this.extraClass).appendTo(this.el);
        }
        return this;
      };

      return Actions;

    })(Backbone.View));
    exporting(ActionBar = (function(_super) {

      __extends(ActionBar, _super);

      function ActionBar() {
        return ActionBar.__super__.constructor.apply(this, arguments);
      }

      ActionBar.prototype.extraClass = "im-action";

      ActionBar.prototype.actionClasses = function() {
        return [intermine.query.columns.ColumnAdder, ListManager, CodeGenerator, Exporters];
      };

      return ActionBar;

    })(Actions));
    ListDialogue = (function(_super) {

      __extends(ListDialogue, _super);

      function ListDialogue() {
        this.selectionChanged = __bind(this.selectionChanged, this);
        return ListDialogue.__super__.constructor.apply(this, arguments);
      }

      ListDialogue.prototype.tagName = "li";

      ListDialogue.prototype.className = "im-list-dialogue dropdown";

      ListDialogue.prototype.usingDefaultName = true;

      ListDialogue.prototype.initialize = function(query) {
        var _this = this;
        this.query = query;
        this.types = {};
        this.model = new Backbone.Model();
        return this.query.on("imo:selected", function(type, id, selected) {
          var commonType, m, types;
          if (selected) {
            _this.types[id] = type;
          } else {
            delete _this.types[id];
          }
          types = _(_this.types).values();
          if (types.length > 0) {
            m = _this.query.service.model;
            commonType = m.findCommonTypeOfMultipleClasses(types);
            if (commonType !== _this.commonType) {
              _this.newCommonType(commonType);
            }
          }
          return _this.selectionChanged();
        });
      };

      ListDialogue.prototype.selectionChanged = function(n) {
        var hasSelectedItems;
        n || (n = _(this.types).values().length);
        hasSelectedItems = !!n;
        this.$('.btn-primary').attr({
          disabled: !hasSelectedItems
        });
        this.$('.im-selection-instruction').hide();
        this.$('form').show();
        if (n < 1) {
          return this.nothingSelected();
        }
      };

      ListDialogue.prototype.newCommonType = function(type) {
        this.commonType = type;
        return this.query.trigger("common:type:selected", type);
      };

      ListDialogue.prototype.nothingSelected = function() {
        this.$('.im-selection-instruction').slideDown();
        this.$('form').hide();
        return this.query.trigger("selection:cleared");
      };

      ListDialogue.prototype.events = {
        'change .im-list-name': 'listNameChanged',
        'submit form': 'ignore',
        'click form': 'ignore',
        'click .btn-cancel': 'stop'
      };

      ListDialogue.prototype.startPicking = function() {
        var m,
          _this = this;
        this.query.trigger("start:list-creation");
        this.nothingSelected();
        m = this.$('.modal').show(function() {
          return $(this).addClass("in").draggable({
            handle: "h2"
          });
        });
        this.$('.modal-header h2').css({
          cursor: "move"
        }).tooltip({
          title: "Drag me around!"
        });
        return this.$('.btn-primary').unbind('click').click(function() {
          return _this.create();
        });
      };

      ListDialogue.prototype.stop = function(e) {
        var modal;
        this.query.trigger("stop:list-creation");
        modal = this.$('.modal');
        if (modal.is('.ui-draggable')) {
          return this.remove();
        } else {
          return modal.modal('hide');
        }
      };

      ListDialogue.prototype.ignore = function(e) {
        e.preventDefault();
        return e.stopPropagation();
      };

      ListDialogue.prototype.listNameChanged = function() {
        return this.usingDefaultName = false;
      };

      ListDialogue.prototype.create = function(q) {
        throw "Override me!";
      };

      ListDialogue.prototype.openDialogue = function(type, q) {
        var _this = this;
        this.newCommonType(type);
        if (q != null) {
          q.count(this.selectionChanged);
        }
        this.$('.modal').modal("show").find('form').show();
        return this.$('.btn-primary').unbind('click').click(function() {
          return _this.create(q, type);
        });
      };

      ListDialogue.prototype.render = function() {
        var _this = this;
        this.$el.append(this.html);
        this.$('.modal').modal({
          show: false
        }).on("hidden", function() {
          return _this.remove();
        });
        return this;
      };

      return ListDialogue;

    })(Backbone.View);
    ListAppender = (function(_super) {

      __extends(ListAppender, _super);

      function ListAppender() {
        this.selectionChanged = __bind(this.selectionChanged, this);
        return ListAppender.__super__.constructor.apply(this, arguments);
      }

      ListAppender.prototype.html = "<div class=\"modal fade\">\n    <div class=\"modal-header\">\n        <a class=\"close btn-cancel\">close</a>\n        <h2>Add Items To Existing List</h2>\n    </div>\n    <div class=\"modal-body\">\n        <form class=\"form-horizontal form\">\n            <fieldset class=\"control-group\">\n                <label>\n                    Add\n                    <span class=\"im-item-count\"></span>\n                    <span class=\"im-item-type\"></span>\n                    to:\n                    <select class=\"im-receiving-list\">\n                        <option value=\"\"><i>Select a list</i></option>\n                    </select>\n                </label>\n                <span class=\"help-inline\"></span>\n            </fieldset>\n        </form>\n        <div class=\"alert alert-error im-none-compatible-error\">\n            <b>Sorry!</b> You don't have access to any compatible lists.\n        </div>\n        <div class=\"alert alert-info im-selection-instruction\">\n            <b>Get started!</b> Choose items from the table below.\n            You can move this dialogue around by dragging it, if you \n            need access to a column it is covering up.\n        </div>\n    </div>\n    <div class=\"modal-footer\">\n        <div class=\"btn-group\">\n            <button disabled class=\"btn btn-primary\">Add to list</button>\n            <button class=\"btn btn-cancel\">Cancel</button>\n        </div>\n    </div>\n</div>";

      ListAppender.prototype.selectionChanged = function(n) {
        ListAppender.__super__.selectionChanged.call(this, n);
        n || (n = _(this.types).values().length);
        this.$('.im-item-count').text(n);
        this.$('.im-item-type').text(intermine.utils.pluralise(this.commonType, n));
        if (n < 1) {
          return this.nothingSelected;
        }
      };

      ListAppender.prototype.nothingSelected = function() {
        var _this = this;
        ListAppender.__super__.nothingSelected.call(this);
        return this.$('form select option').each(function(i, elem) {
          return $(elem).attr({
            disabled: false
          });
        });
      };

      ListAppender.prototype.newCommonType = function(type) {
        ListAppender.__super__.newCommonType.call(this, type);
        return this.onlyShowCompatibleOptions();
      };

      ListAppender.prototype.onlyShowCompatibleOptions = function() {
        var compatibles, m, type,
          _this = this;
        type = this.commonType;
        m = this.query.service.model;
        compatibles = 0;
        this.$('form select option').each(function(i, elem) {
          var $o, compat, path;
          $o = $(elem);
          $o.attr({
            disabled: true
          });
          if (type && elem.value) {
            path = m.getPathInfo(type);
            compat = path.isa($o.data("type"));
            $o.attr({
              disabled: !compat
            });
            if (compat) {
              return compatibles++;
            }
          }
        });
        this.$('.btn-primary').attr({
          disabled: compatibles < 1
        });
        if (type) {
          return this.$('.im-none-compatible-error').toggle(compatibles < 1);
        }
      };

      ListAppender.prototype.create = function(q) {
        var backToNormal, cg, ids, ilh, lName, listQ, receiver, selectedOption, targetSize, targetType,
          _this = this;
        ids = _(this.types).keys();
        receiver = this.$('.im-receiving-list');
        if (!(lName = receiver.val())) {
          cg = receiver.closest('.control-group').addClass('error');
          ilh = this.$('.help-inline').text("No receiving list selected").show();
          backToNormal = function() {
            return ilh.fadeOut(1000, function() {
              ilh.text("");
              return cg.removeClass("error");
            });
          };
          _.delay(backToNormal, 5000);
          return false;
        }
        selectedOption = receiver.find(':selected').first();
        targetType = selectedOption.data('type');
        targetSize = selectedOption.data('size');
        listQ = q || {
          select: ["id"],
          from: targetType,
          where: {
            id: ids
          }
        };
        return this.query.service.query(listQ, function(q) {
          var promise;
          promise = q.appendToList(receiver.val(), function(updatedList) {
            _this.query.trigger("list-update:success", updatedList, updatedList.size - parseInt(targetSize));
            return _this.stop();
          });
          return promise.fail(function(xhr, level, message) {
            if (xhr.responseText) {
              message = (JSON.parse(xhr.responseText)).error;
            }
            return _this.query.trigger("list-update:failure", message);
          });
        });
      };

      ListAppender.prototype.render = function() {
        ListAppender.__super__.render.call(this);
        this.fillSelect();
        return this;
      };

      ListAppender.prototype.fillSelect = function() {
        var _this = this;
        this.query.service.fetchLists(function(ls) {
          var toOpt;
          toOpt = function(l) {
            return _this.make("option", {
              value: l.name,
              "data-type": l.type,
              "data-size": l.size
            }, "" + l.name + " (" + l.size + " " + (intermine.utils.pluralise(l.type, l.size)) + ")");
          };
          _this.$('.im-receiving-list').append(ls.filter(function(l) {
            return !l.hasTag("im:public");
          }).map(toOpt));
          return _this.onlyShowCompatibleOptions();
        });
        return this;
      };

      ListAppender.prototype.startPicking = function() {
        ListAppender.__super__.startPicking.call(this);
        return this.$('.im-none-compatible-error').hide();
      };

      return ListAppender;

    })(ListDialogue);
    openWindowWithPost = function(uri, name, params) {
      var form, value, w;
      form = $("<form method=\"POST\" action=\"" + uri + "\" target=\"" + name + "\">");
      for (name in params) {
        value = params[name];
        form.append("<input name=\"" + name + "\" value=\"" + value + "\" type=\"hidden\">");
      }
      form.appendTo('body');
      w = window.open("someNonExistantPathToSomeWhere", name);
      form.submit();
      form.remove();
      return w.close();
    };
    EXPORT_FORMATS = [
      {
        name: "Spreadsheet (tab separated values)",
        extension: "tab"
      }, {
        name: "Spreadsheet (comma separated values)",
        extension: "csv"
      }, null, {
        name: "XML",
        extension: "xml"
      }, {
        name: "JSON",
        extension: "json"
      }, null, {
        name: "UCSC-BED",
        extension: "bed"
      }, {
        name: "FASTA",
        extension: "fasta"
      }, {
        name: "GFF3",
        extension: "gff3"
      }
    ];
    Exporters = (function(_super) {

      __extends(Exporters, _super);

      function Exporters() {
        this.getExport = __bind(this.getExport, this);

        this.doMainAction = __bind(this.doMainAction, this);

        this.changeDestination = __bind(this.changeDestination, this);
        return Exporters.__super__.constructor.apply(this, arguments);
      }

      Exporters.prototype.tagName = "li";

      Exporters.prototype.className = "im-exporters";

      Exporters.prototype.html = _.template("<div class=\"btn-group\">\n    <a class=\"btn btn-action\" href=\"#\">\n        <i class=\"icon-download-alt\"></i>\n        Export\n        <span class=\"im-export-format\"></span>\n    </a>\n    <a class=\"btn dropdown-toggle\" data-toggle=\"dropdown\" href=\"#\" style=\"height: 18px\">\n        <b class=\"caret\"></b>\n    </a>\n    <ul class=\"dropdown-menu pull-right\">\n        <% _(formats).each(function(format) { %>\n            <% if (format) { %>\n                <li>\n                    <a href=\"#\" data-format=\"<%= format.extension %>\">\n                        <%= format.name %>\n                    </a>\n                </li>\n            <% } else { %>\n                <li class=\"divider\"></li>\n            <% } %>\n        <% }); %>\n        <li>\n            <form class=\"form form-inline im-export-destinations\">\n                <div class=\"btn-group\" data-toggle=\"buttons-radio\">\n                    <button class=\"btn active\" data-destination=\"download\">\n                        Download\n                    </button>\n                    <button class=\"btn\" data-destination=\"galaxy\">\n                        Export To Galaxy\n                    </button>\n                </div>\n            </form>\n        </li>\n    </ul>\n</div>\n<div class=\"modal fade\">\n    <div class=\"modal-header\">\n        <a class=\"close\" data-dismiss=\"modal\">close</a>\n        <h3>Export Options</h3>\n    </div>\n    <!-- TODO -->\n    <div class=\"modal-body\">\n        <form class=\"form\">\n            <label>All rows\n                <input type=\"checkbox\" checked>\n            </label>\n            <label>start\n                <input type=\"text\">\n            </label>\n            <label>end\n                <input type=\"text\">\n            </label>\n        </form>\n    </div>\n    <div class=\"modal-footer\">\n        <a href=\"#\" class=\"btn btn-save\"><i class=\"icon-file\"></i>Save</a>\n        <button href=\"#\" class=\"btn im-show-comments\" data-toggle=\"button\">Show Comments</button>\n        <a href=\"#\" data-dismiss=\"modal\" class=\"btn\">Close</a>\n    </div>\n</div>", {
        formats: EXPORT_FORMATS
      });

      Exporters.prototype.initialize = function(query) {
        this.query = query;
      };

      Exporters.prototype.render = function() {
        this.$el.append(this.html);
        this.destination = this.$('form .btn.active').data('destination');
        return this;
      };

      Exporters.prototype.events = {
        'click .dropdown-menu a': 'getExport',
        'click .btn-action': 'doMainAction',
        'click .form .btn': 'changeDestination'
      };

      Exporters.prototype.changeDestination = function(e) {
        var $t;
        e.stopPropagation();
        e.preventDefault();
        $t = $(e.target).button('toggle');
        return this.destination = $t.data('destination');
      };

      Exporters.prototype.doMainAction = function(e) {
        if (this.format) {
          return this.getExport(e);
        } else {
          return $(e.target).next().dropdown('toggle');
        }
      };

      Exporters.prototype.getExport = function(e) {
        var $t, uri;
        $t = $(e.target);
        this.format = $t.data('format') || this.format;
        this.$('a .im-export-format').text("as " + this.format);
        uri = this.query.getExportURI(this.format);
        return this[this.destination](uri);
      };

      Exporters.prototype.download = function(uri) {
        return window.open(uri);
      };

      Exporters.prototype.galaxy = function(uri) {
        var c, lists,
          _this = this;
        lists = (function() {
          var _i, _len, _ref, _results;
          _ref = this.query.constraints;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            c = _ref[_i];
            if (c.op === "IN") {
              _results.push(c.value);
            }
          }
          return _results;
        }).call(this);
        return intermine.utils.getOrganisms(this.query, function(orgs) {
          var req;
          req = {
            "tool_id": "flymine",
            "organism": orgs.join(", "),
            "info": "" + _this.query.root + " data from " + _this.query.service.root + " \nUploaded from " + (window.location.toString().replace(/\?.*/, "")) + ".\n" + (lists.length ? ' source: ' + lists.join(",") : "") + "\n" + (orgs.length ? ' organisms: ' : "") + (orgs.join(",")) + " ",
            "URL": uri,
            "name": "" + (orgs.length === 1 ? orgs[0] + ' ' : "") + _this.query.root + " data",
            "data_type": _this.format === "tab" ? "tabular" : _this.format
          };
          return openWindowWithPost("http://main.g2.bx.psu.edu/tool_runner", "Upload", req);
        });
      };

      return Exporters;

    })(Backbone.View);
    CODE_GEN_LANGS = [
      {
        name: "Perl",
        extension: "pl"
      }, {
        name: "Python",
        extension: "py"
      }, {
        name: "Ruby",
        extension: "rb"
      }, {
        name: "Java",
        extension: "java"
      }, {
        name: "JavaScript",
        extension: "js"
      }
    ];
    CodeGenerator = (function(_super) {

      __extends(CodeGenerator, _super);

      function CodeGenerator() {
        this.expand = __bind(this.expand, this);

        this.compact = __bind(this.compact, this);

        this.doMainAction = __bind(this.doMainAction, this);

        this.getAndShowCode = __bind(this.getAndShowCode, this);

        this.showComments = __bind(this.showComments, this);

        this.render = __bind(this.render, this);
        return CodeGenerator.__super__.constructor.apply(this, arguments);
      }

      CodeGenerator.prototype.tagName = "li";

      CodeGenerator.prototype.className = "im-code-gen";

      CodeGenerator.prototype.html = _.template("<div class=\"btn-group\">\n    <a class=\"btn btn-action\" href=\"#\">\n        <i class=\"icon-script\"></i>\n        Get <span class=\"im-code-lang\"></span> code\n    </a>\n    <a class=\"btn dropdown-toggle\" data-toggle=\"dropdown\" href=\"#\" style=\"height: 18px\">\n        <span class=\"caret\"></span>\n    </a>\n    <ul class=\"dropdown-menu\">\n        <% _(langs).each(function(lang) { %>\n          <li>\n            <a href=\"#\" data-lang=\"<%= lang.extension %>\">\n               <i class=\"icon-<%= lang.extension %>\"></i>\n               <%= lang.name %>\n            </a>\n          </li>\n        <% }); %>\n    </ul>\n</div>\n<div class=\"modal fade\">\n    <div class=\"modal-header\">\n        <a class=\"close\" data-dismiss=\"modal\">close</a>\n        <h3>Generated <span class=\"im-code-lang\"></span> Code</h3>\n    </div>\n    <div class=\"modal-body\">\n        <pre class=\"im-generated-code prettyprint linenums\">\n        </pre>\n    </div>\n    <div class=\"modal-footer\">\n        <a href=\"#\" class=\"btn btn-save\"><i class=\"icon-file\"></i>Save</a>\n        <button href=\"#\" class=\"btn im-show-comments\" data-toggle=\"button\">Show Comments</button>\n        <a href=\"#\" data-dismiss=\"modal\" class=\"btn\">Close</a>\n    </div>\n</div>", {
        langs: CODE_GEN_LANGS
      });

      CodeGenerator.prototype.initialize = function(query) {
        this.query = query;
      };

      CodeGenerator.prototype.render = function() {
        this.$el.append(this.html);
        return this;
      };

      CodeGenerator.prototype.events = {
        'click .im-show-comments': 'showComments',
        'click .dropdown-menu a': 'getAndShowCode',
        'click .btn-action': 'doMainAction'
      };

      CodeGenerator.prototype.showComments = function(e) {
        if ($(e.target).is('.active')) {
          return this.compact();
        } else {
          return this.expand();
        }
      };

      CodeGenerator.prototype.getAndShowCode = function(e) {
        var $m, $t,
          _this = this;
        $t = $(e.target);
        $m = this.$('.modal');
        this.lang = $t.data('lang') || this.lang;
        $m.find('.btn-save').attr({
          href: this.query.getCodeURI(this.lang)
        });
        $m.find('h3 .im-code-lang').text(this.lang);
        this.$('a .im-code-lang').text(this.lang);
        return this.query.fetchCode(this.lang, function(code) {
          $m.find('pre').text(code);
          $m.modal('show');
          return prettyPrint(_this.compact);
        });
      };

      CodeGenerator.prototype.doMainAction = function(e) {
        if (this.lang) {
          return this.getAndShowCode(e);
        } else {
          return $(e.target).next().dropdown('toggle');
        }
      };

      CodeGenerator.prototype.compact = function() {
        var $m;
        $m = this.$('.modal');
        $m.find('span.com').closest('li').slideUp();
        return $m.find('.linenums li').filter(function() {
          return $(this).text().replace(/\s+/g, "") === "";
        }).slideUp();
      };

      CodeGenerator.prototype.expand = function() {
        var $m;
        $m = this.$('.modal');
        return $m.find('linenums li').slideDown();
      };

      return CodeGenerator;

    })(Backbone.View);
    ListCreator = (function(_super) {

      __extends(ListCreator, _super);

      function ListCreator() {
        this.updateTagBox = __bind(this.updateTagBox, this);

        this.handleFailure = __bind(this.handleFailure, this);

        this.handleSuccess = __bind(this.handleSuccess, this);

        this.makeNewList = __bind(this.makeNewList, this);
        return ListCreator.__super__.constructor.apply(this, arguments);
      }

      ListCreator.prototype.html = "<div class=\"modal fade im-list-creation-dialogue\">\n    <div class=\"modal-header\">\n        <a class=\"close btn-cancel\">close</a>\n        <h2>List Details</h2>\n    </div>\n    <div class=\"modal-body\">\n        <form class=\"form form-horizontal\">\n            <p class=\"im-list-summary\"></p>\n            <fieldset class=\"control-group\">\n                <label>Name</label>\n                <input class=\"im-list-name input-xlarge\" type=\"text\" placeholder=\"required identifier\">\n                <span class=\"help-inline\"></span>\n            </fieldset>\n            <fieldset class=\"control-group\">\n                <label>Description</label>\n                <input class=\"im-list-desc input-xlarge\" type=\"text\" placeholder=\"an optional description\" >\n            </fieldset>\n            <fieldset class=\"control-group\">\n                <label>Add Tags</label>\n                <input type=\"text\" class=\"im-available-tags input-medium\" placeholder=\"categorize your list\">\n                <button class=\"btn im-confirm-tag\" disabled>Add</button>\n                <ul class=\"im-list-tags choices well\">\n                    <div style=\"clear:both\"></div>\n                </ul>\n                <h5><i class=\"icon-chevron-down\"></i>Suggested Tags</h5>\n                <ul class=\"im-list-tags suggestions well\">\n                    <div style=\"clear:both\"></div>\n                </ul>\n            </fieldset>\n            <input type=\"hidden\" class=\"im-list-type\">\n        </form>\n        <div class=\"alert alert-info im-selection-instruction\">\n            <b>Get started!</b> Choose items from the table below.\n            You can move this dialogue around by dragging it, if you \n            need access to a column it is covering up.\n        </div>\n    </div>\n    <div class=\"modal-footer\">\n        <div class=\"btn-group\">\n            <button class=\"btn btn-primary\">Create</button>\n            <button class=\"btn btn-cancel\">Cancel</button>\n            <button class=\"btn btn-reset\">Reset</button>\n        </div>\n    </div>\n</div>";

      ListCreator.prototype.initialize = function(query) {
        this.query = query;
        ListCreator.__super__.initialize.call(this, this.query);
        this.tags = new UniqItems();
        this.suggestedTags = new UniqItems();
        this.tags.on("add", this.updateTagBox);
        this.tags.on("remove", this.updateTagBox);
        return this.initTags();
      };

      ListCreator.prototype.newCommonType = function(type) {
        var $target, text;
        ListCreator.__super__.newCommonType.call(this, type);
        text = "List of " + (intermine.utils.pluralise(type)) + " (" + (new Date()) + ")";
        $target = this.$('.im-list-name');
        if (this.usingDefaultName) {
          $target.val(text);
          this.usingDefaultName = true;
        }
        return this.$('.im-list-type').val(type);
      };

      ListCreator.prototype.openDialogue = function(type, q) {
        ListCreator.__super__.openDialogue.call(this, type, q);
        return this.initTags();
      };

      ListCreator.prototype.initTags = function() {
        var c, _fn, _i, _len, _ref,
          _this = this;
        this.tags.reset();
        this.suggestedTags.reset();
        _ref = this.query.constraints;
        _fn = function(c) {
          var title;
          title = c.title || c.path.replace(/^[^\.]+\./, "");
          if (c.op === "IN") {
            return _this.suggestedTags.add("source: " + c.value);
          } else if (c.op === "=") {
            return _this.suggestedTags.add("" + title + ": " + c.value);
          } else if (c.op === "<") {
            return _this.suggestedTags.add("" + title + " below " + c.value);
          } else if (c.op === ">") {
            return _this.suggestedTags.add("" + title + " above " + c.value);
          } else if (c.type) {
            return _this.suggestedTags.add("" + title + " is a " + c.type);
          } else {
            return _this.suggestedTags.add("" + title + " " + c.op + " " + (c.value || c.values));
          }
        };
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          _fn(c);
        }
        return this.updateTagBox();
      };

      ListCreator.prototype.events = _.extend({}, ListDialogue.prototype.events, {
        'click .label .remove-tag': 'removeTag',
        'click .label .accept-tag': 'acceptTag',
        'click .im-confirm-tag': 'addTag',
        'click .btn-reset': 'reset',
        'click .control-group h5': 'rollUpNext'
      });

      ListCreator.prototype.rollUpNext = function(e) {
        $(e.target).next().slideToggle();
        return $(e.target).find("i").toggleClass("icon-chevron-right icon-chevron-down");
      };

      ListCreator.prototype.reset = function() {
        var field, _i, _len, _ref;
        _ref = ["name", "desc", "type"];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          field = _ref[_i];
          this.$(".im-list-" + field).val("");
        }
        return this.initTags();
      };

      ListCreator.prototype.create = function(q) {
        var $nameInput, illegals, listQ, newListDesc, newListName, newListTags, newListType, opts;
        $nameInput = this.$('.im-list-name');
        newListName = $nameInput.val();
        newListDesc = this.$('.im-list-desc').val();
        newListType = this.$('.im-list-type').val();
        newListTags = this.tags.map(function(t) {
          return t.get("item");
        });
        if (!newListName) {
          $nameInput.next().text("A list requires a name. Please enter one.");
          return $nameInput.parent().addClass("error");
        } else if (illegals = newListName.match(ILLEGAL_LIST_NAME_CHARS)) {
          $nameInput.next().text("This name contains illegal characters (" + illegals + "). Please remove them");
          return $nameInput.parent().addClass("error");
        } else {
          listQ = q || {
            select: ["id"],
            from: newListType,
            where: {
              id: _(this.types).keys()
            }
          };
          opts = {
            name: newListName,
            description: newListDesc,
            tags: newListTags
          };
          this.makeNewList(listQ, opts);
          return this.$('.btn-primary').unbind('click');
        }
      };

      ListCreator.prototype.makeNewList = function(query, opts) {
        var _this = this;
        if (query.service != null) {
          query.saveAsList(opts, this.handleSuccess).fail(this.handleFailure);
          return this.stop();
        } else {
          return this.query.service.query(query, function(q) {
            return _this.makeNewList(q, opts);
          });
        }
      };

      ListCreator.prototype.handleSuccess = function(list) {
        console.log("Created a list", list);
        return this.query.trigger("list-creation:success", list);
      };

      ListCreator.prototype.handleFailure = function(xhr, level, message) {
        if (xhr.responseText) {
          message = (JSON.parse(xhr.responseText)).error;
        }
        return this.query.trigger("list-creation:failure", message);
      };

      ListCreator.prototype.removeTag = function(e) {
        var tag;
        tag = $(e.target).siblings('.tag-text').text();
        this.tags.remove(tag);
        return $('.tooltip').remove();
      };

      ListCreator.prototype.acceptTag = function(e) {
        var tag;
        tag = $(e.target).siblings('.tag-text').text();
        $('.tooltip').remove();
        this.suggestedTags.remove(tag);
        return this.tags.add(tag);
      };

      ListCreator.prototype.updateTagBox = function() {
        var box;
        box = this.$('.im-list-tags.choices');
        box.empty();
        this.tags.each(function(t) {
          var $li;
          $li = $("<li title=\"" + (t.escape("item")) + "\">\n    <span class=\"label label-warning\">\n        <i class=\"icon-tag icon-white\"></i>\n        <span class=\"tag-text\">" + (t.escape("item")) + "</span>\n        <i class=\"icon-remove-circle icon-white remove-tag\"></i>\n    </span>\n</li>");
          return $li.tooltip({
            placement: "top"
          }).appendTo(box);
        });
        box.append("<div style=\"clear:both\"></div>");
        box = this.$('.im-list-tags.suggestions');
        box.empty();
        this.suggestedTags.each(function(t) {
          var $li;
          $li = $("<li title=\"This tag is a suggestion. Click the 'ok' sign to add it\">\n    <span class=\"label\">\n        <i class=\"icon-tag icon-white\"></i>\n        <span class=\"tag-text\">" + (t.escape("item")) + "</span>\n        <i class=\"icon-ok-circle icon-white accept-tag\"></i>\n    </span>\n</li>");
          return $li.tooltip({
            placement: "top"
          }).appendTo(box);
        });
        return box.append("<div style=\"clear:both\"></div>");
      };

      ListCreator.prototype.addTag = function(e) {
        var tagAdder;
        e.preventDefault();
        tagAdder = this.$('.im-available-tags');
        this.tags.add(tagAdder.val());
        tagAdder.val("");
        return tagAdder.next().attr({
          disabled: true
        });
      };

      ListCreator.prototype.render = function() {
        var tagAdder,
          _this = this;
        ListCreator.__super__.render.call(this);
        this.updateTagBox();
        tagAdder = this.$('.im-available-tags');
        this.$('a').button();
        this.query.service.fetchLists(function(ls) {
          var tags;
          tags = _(ls).reduce((function(a, l) {
            return _.union(a, l.tags);
          }), []);
          return tagAdder.typeahead({
            source: tags,
            items: 10,
            matcher: function(item) {
              var pattern;
              if (!this.query) {
                return true;
              }
              pattern = new RegExp(this.query, "i");
              return pattern.test(item);
            }
          });
        });
        tagAdder.keyup(function(e) {
          _this.$('.im-confirm-tag').attr("disabled", false);
          if (e.which === 13) {
            return _this.addTag(e);
          }
        });
        return this;
      };

      return ListCreator;

    })(ListDialogue);
    return ListManager = (function(_super) {

      __extends(ListManager, _super);

      function ListManager() {
        this.updateTypeOptions = __bind(this.updateTypeOptions, this);

        this.changeAction = __bind(this.changeAction, this);
        return ListManager.__super__.constructor.apply(this, arguments);
      }

      ListManager.prototype.tagName = "li";

      ListManager.prototype.className = "im-list-management dropdown";

      ListManager.prototype.initialize = function(query) {
        this.query = query;
        this.query.on("change:views", this.updateTypeOptions);
        return this.action = ListManager.actions.create;
      };

      ListManager.prototype.html = "<a href=\"#\" class=\"btn\" data-toggle=\"dropdown\">\n    <i class=\"icon-list-alt\"></i>\n    Create / Add to list\n    <b class=\"caret\"></b>\n</a>\n<ul class=\"dropdown-menu im-type-options\">\n    <div class=\"btn-group\" data-toggle=\"buttons-radio\">\n        <button class=\"btn active im-list-action-chooser\" data-action=\"create\">\n            Create New List\n        </button>\n        <button class=\"btn im-list-action-chooser\" data-action=\"append\">\n            Add to Existing List\n        </button>\n    </div>\n</ul>";

      ListManager.prototype.events = {
        'click .btn-group > .im-list-action-chooser': 'changeAction',
        'click .im-pick-and-choose': 'startPicking'
      };

      ListManager.actions = {
        create: ListCreator,
        append: ListAppender
      };

      ListManager.prototype.changeAction = function(e) {
        var $t;
        e.stopPropagation();
        e.preventDefault();
        $t = $(e.target).button("toggle");
        return this.action = ListManager.actions[$t.data('action')];
      };

      ListManager.prototype.openDialogue = function(type, q) {
        var dialog;
        dialog = new this.action(this.query);
        dialog.render().$el.appendTo(this.el);
        return dialog.openDialogue(type, q);
      };

      ListManager.prototype.startPicking = function() {
        var dialog;
        dialog = new this.action(this.query);
        dialog.render().$el.appendTo(this.el);
        return dialog.startPicking();
      };

      ListManager.prototype.updateTypeOptions = function() {
        var node, ul, _fn, _i, _len, _ref,
          _this = this;
        ul = this.$('.im-type-options');
        ul.find("li").remove();
        _ref = this.query.getViewNodes();
        _fn = function(node) {
          var colNos, countQuery, i, li, v;
          li = $("<li></li>");
          ul.append(li);
          countQuery = _this.query.clone();
          countQuery.select([node.append("id").toPathString()]);
          countQuery.orderBy([]);
          li.click(function() {
            return _this.openDialogue(node.getType().name, countQuery);
          });
          colNos = (function() {
            var _j, _len1, _ref1, _results;
            _ref1 = this.query.views;
            _results = [];
            for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
              v = _ref1[i];
              if (this.query.getPathInfo(v).getParent().toPathString() === node.toPathString()) {
                _results.push(i + 1);
              }
            }
            return _results;
          }).call(_this);
          li.mouseover(function() {
            return _this.query.trigger("start:highlight:node", node);
          });
          li.mouseout(function() {
            return _this.query.trigger("stop:highlight");
          });
          return countQuery.count(function(n) {
            var col, quantifier, typeName;
            if (n < 1) {
              return li.remove();
            }
            quantifier = (function() {
              switch (n) {
                case 1:
                  return "The";
                case 2:
                  return "Both";
                default:
                  return "All " + n;
              }
            })();
            typeName = intermine.utils.pluralise(node.getType().name, n);
            col = intermine.utils.pluralise("column", colNos.length);
            return li.append("<a href=\"#\">\n    " + quantifier + " " + typeName + " from " + col + " " + (colNos.join(", ")) + "\n</a>");
          });
        };
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          node = _ref[_i];
          _fn(node);
        }
        return ul.append("<li class=\"im-pick-and-choose\">\n    <a href=\"#\">Choose individual items from the table</a>\n</li>");
      };

      ListManager.prototype.render = function() {
        this.$el.append(this.html);
        this.updateTypeOptions();
        return this;
      };

      return ListManager;

    })(Backbone.View);
  });

  scope("intermine.results.table", function(exporting) {
    var CELL_HTML, Cell, HIDDEN_FIELDS, NullCell, SubTable;
    CELL_HTML = _.template("<input class=\"list-chooser\" type=\"checkbox\" style=\"display: none\" data-obj-id=\"<%= id %>\" \n    <% if (selected) { %>checked <% }; %>\n    data-obj-type=\"<%= type %>\">\n<% if (value == null) { %>\n<span class=\"null-value\">no value</span>\n<% } else { %>\n    <a class=\"im-cell-link\" href=\"<%= base %><%= url %>\"><%= value %></a>\n<% } %>\n<% if (field == 'url') { %>\n    <a class=\"im-cell-link external\" href=\"<%= value %>\"><i class=\"icon-globe\"></i>link</a>\n<% } %>");
    HIDDEN_FIELDS = ["class", "objectId"];
    exporting(SubTable = (function(_super) {

      __extends(SubTable, _super);

      function SubTable() {
        return SubTable.__super__.constructor.apply(this, arguments);
      }

      SubTable.prototype.tagName = "td";

      SubTable.prototype.className = "im-result-subtable";

      SubTable.prototype.initialize = function(query, cellify, subtable) {
        var _this = this;
        this.query = query;
        this.cellify = cellify;
        this.rows = subtable.rows;
        this.view = subtable.view;
        this.column = this.query.getPathInfo(subtable.column);
        this.query.on('expand:subtables', function(path) {
          if (path.toString() === _this.column.toString()) {
            return _this.$('.im-subtable').slideDown();
          }
        });
        return this.query.on('collapse:subtables', function(path) {
          if (path.toString() === _this.column.toString()) {
            return _this.$('.im-subtable').slideUp();
          }
        });
      };

      SubTable.prototype.getSummaryText = function() {
        if (this.column.isCollection()) {
          return "" + this.rows.length + " " + (this.column.getType().name) + "s";
        } else {
          if (this.rows.length === 0) {
            return "No " + (this.column.getType().name);
          } else {
            return "" + this.rows[0][0].value + " (" + (this.rows[0].slice(1).map(function(c) {
              return c.value;
            }).join(', ')) + ")";
          }
        }
      };

      SubTable.prototype.render = function() {
        var colRoot, colStr, icon, row, summary, t, v, _fn, _fn1, _i, _j, _len, _len1, _ref, _ref1,
          _this = this;
        icon = this.rows.length > 0 ? '<i class=icon-th-list></i>' : '<i class=icon-non-existent></i>';
        summary = $("<span>" + icon + "&nbsp;" + (this.getSummaryText()) + "</span>");
        summary.addClass('im-subtable-summary').appendTo(this.$el);
        t = $('<table><thead><tr></tr></thead><tbody></tbody></table>');
        colRoot = this.column.getType().name;
        colStr = this.column.toString();
        if (this.rows.length > 0) {
          _ref = this.view;
          _fn = function(v) {
            var path, th;
            th = $("<th>\n    <i class=\"" + intermine.css.headerIconRemove + "\"></i>\n    <span></span>\n</th>");
            th.find('i').click(function(e) {
              return _this.query.removeFromSelect(v);
            });
            path = _this.query.getPathInfo(v);
            _this.column.getDisplayName(function(colName) {
              var span;
              span = th.find('span');
              return path.getDisplayName(function(pathName) {
                if (pathName.match(colName)) {
                  return span.text(pathName.replace(colName, '').replace(/^\s*>?\s*/, ''));
                } else {
                  return span.text(pathName.replace(/^[^>]*\s*>\s*/, ''));
                }
              });
            });
            return t.children('thead').children('tr').append(th);
          };
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            v = _ref[_i];
            _fn(v);
          }
          _ref1 = this.rows;
          _fn1 = function(t, row) {
            var cell, tr, w, _fn2, _k, _len2;
            tr = $('<tr>');
            w = _this.$el.width() / _this.view.length;
            _fn2 = function(tr, cell) {
              return tr.append((_this.cellify(cell)).render().setWidth(w).el);
            };
            for (_k = 0, _len2 = row.length; _k < _len2; _k++) {
              cell = row[_k];
              _fn2(tr, cell);
            }
            t.children('tbody').append(tr);
            return null;
          };
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            row = _ref1[_j];
            _fn1(t, row);
          }
        }
        t.addClass('im-subtable table table-condensed table-striped');
        this.$el.append(t);
        summary.css({
          cursor: 'pointer'
        }).click(function(e) {
          console.log(t);
          e.stopPropagation();
          if (t.is(':visible')) {
            _this.query.trigger('subtable:collapsed', _this.column);
          } else {
            _this.query.trigger('subtable:expanded', _this.column);
          }
          return t.slideToggle();
        });
        return this;
      };

      SubTable.prototype.getUnits = function() {
        if (this.rows.length = 0) {
          return this.view.length;
        } else {
          return _.reduce(this.rows[0], (function(a, item) {
            return a + (item.view != null ? item.view.length : 1);
          }), 0);
        }
      };

      SubTable.prototype.setWidth = function(w) {
        this.$el.css({
          width: (w * this.view.length) + "px"
        });
        this.$('.im-cell-link').css({
          "max-width": ((w * this.view.length) - 5) + "px"
        });
        return this;
      };

      return SubTable;

    })(Backbone.View));
    exporting(Cell = (function(_super) {

      __extends(Cell, _super);

      function Cell() {
        return Cell.__super__.constructor.apply(this, arguments);
      }

      Cell.prototype.tagName = "td";

      Cell.prototype.className = "im-result-field";

      Cell.prototype.getUnits = function() {
        return 1;
      };

      Cell.prototype.events = {
        'click': 'activateChooser'
      };

      Cell.prototype.initialize = function() {
        var _this = this;
        this.model.on("change:selected", function(model, selected) {
          _this.$el.toggleClass("active", selected);
          return _this.$('input').attr({
            checked: selected
          });
        });
        this.model.on("change:selectable", function(model, selectable) {
          return _this.$('input').attr({
            disabled: !selectable
          });
        });
        this.options.query.on("start:list-creation", function() {
          if (_this.model.get("selectable")) {
            return _this.$('input').show();
          }
        });
        this.options.query.on("stop:list-creation", function() {
          _this.$('input').hide();
          _this.$el.removeClass("active");
          return _this.model.set("selected", false);
        });
        this.options.query.on("start:highlight:node", function(node) {
          var _ref;
          if (((_ref = _this.options.node) != null ? _ref.toPathString() : void 0) === node.toPathString()) {
            return _this.$el.addClass("im-highlight");
          }
        });
        return this.options.query.on("stop:highlight", function() {
          return _this.$el.removeClass("im-highlight");
        });
      };

      Cell.prototype.setupPreviewOverlay = function() {
        var cellLink, content, id, s, type;
        content = $("<table class=\"im-item-details table table-condensed table-bordered\">\n<colgroup>\n    <col class=\"im-item-field\"/>\n    <col class=\"im-item-value\"/>\n</colgroup>\n</table>");
        type = this.model.get('type');
        id = this.model.get('id');
        s = this.options.query.service;
        return cellLink = this.$el.find('.im-cell-link').first().popover({
          placement: function() {
            var table;
            table = cellLink.closest("table");
            if (cellLink.offset().left + 300 >= table.offset().left + table.width()) {
              return "left";
            } else {
              return "right";
            }
          },
          title: type,
          trigger: "hover",
          delay: {
            show: 500,
            hide: 100
          },
          content: function() {
            if (!cellLink.data("content")) {
              s.findById(type, id, function(item) {
                var field, getLeaves, v, value, values;
                for (field in item) {
                  value = item[field];
                  if (!(value && (__indexOf.call(HIDDEN_FIELDS, field) < 0) && !value['objectId'])) {
                    continue;
                  }
                  v = value + "";
                  v = v.length > 100 ? v.substring(0, 100) + "..." : v;
                  content.append("<tr>\n    <td>" + field + "</td>\n    <td>" + v + "</td>\n</tr>");
                }
                getLeaves = function(o) {
                  var leaf, leaves, name, values, x, _i, _len;
                  leaves = [];
                  values = (function() {
                    var _results;
                    _results = [];
                    for (name in o) {
                      leaf = o[name];
                      if (__indexOf.call(HIDDEN_FIELDS, name) < 0) {
                        _results.push(leaf);
                      }
                    }
                    return _results;
                  })();
                  for (_i = 0, _len = values.length; _i < _len; _i++) {
                    x = values[_i];
                    if (x['objectId']) {
                      leaves = leaves.concat(getLeaves(x));
                    } else {
                      leaves.push(x);
                    }
                  }
                  return leaves;
                };
                for (field in item) {
                  value = item[field];
                  if (!(value && value['objectId'])) {
                    continue;
                  }
                  values = getLeaves(value);
                  content.append("<tr>\n    <td>" + field + "</td>\n    <td>" + (values.join(', ')) + "</td>\n</tr>");
                }
                cellLink.data({
                  content: content
                });
                return cellLink.popover("show");
              });
            }
            return content;
          }
        });
      };

      Cell.prototype.render = function() {
        var html, id, s, type;
        html = CELL_HTML(_.extend({}, this.model.toJSON(), {
          value: this.model.get(this.options.field),
          field: this.options.field
        }));
        this.$el.append(html).toggleClass({
          active: this.model.get("selected")
        });
        type = this.model.get("type");
        id = this.model.get("id");
        s = this.options.query.service;
        if (id != null) {
          this.setupPreviewOverlay();
        }
        return this;
      };

      Cell.prototype.setWidth = function(w) {
        this.$el.css({
          width: w + "px"
        });
        this.$('.im-cell-link').css({
          "max-width": (w - 5) + "px"
        });
        return this;
      };

      Cell.prototype.activateChooser = function() {
        if (this.model.get("selectable")) {
          if (this.$('input').is(':visible')) {
            return this.model.set({
              selected: !this.model.get("selected")
            });
          }
        }
      };

      return Cell;

    })(Backbone.View));
    return exporting(NullCell = (function(_super) {

      __extends(NullCell, _super);

      function NullCell() {
        return NullCell.__super__.constructor.apply(this, arguments);
      }

      NullCell.prototype.setupPreviewOverlay = function() {};

      NullCell.prototype.initialize = function() {
        this.model = new Backbone.Model({
          selected: false,
          selectable: false,
          value: null,
          id: null,
          url: null,
          base: null,
          type: null
        });
        return NullCell.__super__.initialize.call(this);
      };

      return NullCell;

    })(Cell));
  });

  scope("intermine", function(exporting) {
    var utils;
    return exporting(utils = (function() {

      function utils() {}

      utils.pluralise = function(word, count) {
        if (count === 1) {
          return word;
        } else if (word.match(/(s|x|ch)$/)) {
          return word + "es";
        } else if (word.match(/[^aeiou]y$/)) {
          return word.replace(/y$/, "ies");
        } else {
          return word + "s";
        }
      };

      utils.numToString = function(num, sep, every) {
        var chars, groups, i, len, rets;
        rets = [];
        i = 0;
        chars = (num + "").split("");
        len = chars.length;
        groups = _(chars).groupBy(function(c, i) {
          return Math.floor((len - (i + 1)) / every).toFixed();
        });
        while (groups[i]) {
          rets.unshift(groups[i].join(""));
          i++;
        }
        return rets.join(sep);
      };

      utils.getParameter = function(params, name) {
        return _(params).chain().select(function(p) {
          return p.name === name;
        }).pluck('value').first().value();
      };

      utils.getOrganisms = function(query, cb) {
        var c, n, newView, nodes, onodes, onodes2, orgs, promise, restrictedOrganisms, toRun, v;
        restrictedOrganisms = (function() {
          var _i, _len, _ref, _results;
          _ref = query.constraints;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            c = _ref[_i];
            if (c.path.match(/(o|O)rganism/)) {
              _results.push(c.value);
            }
          }
          return _results;
        })();
        if (restrictedOrganisms.length) {
          return cb(restrictedOrganisms);
        } else {
          toRun = query.clone();
          orgs = [];
          nodes = (function() {
            var _i, _len, _ref, _results;
            _ref = toRun.views;
            _results = [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              v = _ref[_i];
              _results.push(toRun.getPathInfo(v).getParent());
            }
            return _results;
          })();
          onodes = (function() {
            var _i, _len, _results;
            _results = [];
            for (_i = 0, _len = nodes.length; _i < _len; _i++) {
              n = nodes[_i];
              if (n.toPathString() === "Organism" || (n.getType().fields["organism"] != null)) {
                _results.push(n);
              }
            }
            return _results;
          })();
          onodes2 = ((function() {
            var _i, _len, _results;
            if (n.toPathString() === "Organism") {
              return n;
            } else {
              _results = [];
              for (_i = 0, _len = onodes.length; _i < _len; _i++) {
                n = onodes[_i];
                _results.push(n.append("organism"));
              }
              return _results;
            }
          })());
          newView = (function() {
            var _i, _len, _results;
            _results = [];
            for (_i = 0, _len = onodes2.length; _i < _len; _i++) {
              n = onodes2[_i];
              _results.push("" + (n.toPathString()) + ".shortName");
            }
            return _results;
          })();
          toRun.views = _.uniq(newView);
          if (toRun.views.length) {
            toRun.sortOrder = [];
            promise = toRun.rows(function(rows) {
              var row, _i, _len;
              for (_i = 0, _len = rows.length; _i < _len; _i++) {
                row = rows[_i];
                orgs = orgs.concat(row);
              }
              return cb(_.uniq(orgs));
            });
            return promise.fail(function() {
              return cb(orgs);
            });
          } else {
            return cb(orgs);
          }
        }
      };

      return utils;

    })());
  });

  scope("intermine.model", function(exporting) {
    var FPObject, IMObject, NullObject;
    exporting(IMObject = (function(_super) {

      __extends(IMObject, _super);

      function IMObject() {
        return IMObject.__super__.constructor.apply(this, arguments);
      }

      IMObject.prototype.initialize = function(query, obj, field, base) {
        var m, pathInfo,
          _this = this;
        obj.type = obj["class"];
        obj[field] = obj.value;
        obj.base = base;
        obj.selected = false;
        obj.selectable = true;
        this.attributes = obj;
        m = query.service.model;
        pathInfo = m.getPathInfo(obj.type);
        query.on("selection:cleared", function() {
          return _this.set({
            selectable: true
          });
        });
        query.on("common:type:selected", function(type) {
          var typesAreCompatible;
          typesAreCompatible = type && (pathInfo.isa(type) || (m.getPathInfo(type).isa(_this.get("type"))));
          return _this.set({
            selectable: typesAreCompatible || !type
          });
        });
        return this.on("change:selected", function() {
          return query.trigger("imo:selected", this.get("type"), this.get("id"), this.get("selected"));
        });
      };

      IMObject.prototype.merge = function(obj, field) {
        return this.set(field, obj.value);
      };

      return IMObject;

    })(Backbone.Model));
    exporting(NullObject = (function(_super) {

      __extends(NullObject, _super);

      function NullObject() {
        return NullObject.__super__.constructor.apply(this, arguments);
      }

      NullObject.prototype.initialize = function(query, field, type) {
        this.attributes = {};
        this.set(field, null);
        this.set('id', null);
        this.set('type', type);
        this.set('selected', false);
        return this.set('selectable', false);
      };

      NullObject.prototype.merge = function() {};

      return NullObject;

    })(IMObject));
    return exporting(FPObject = (function(_super) {

      __extends(FPObject, _super);

      function FPObject() {
        return FPObject.__super__.constructor.apply(this, arguments);
      }

      FPObject.prototype.initialize = function(query, obj, field) {
        obj.type = obj["class"];
        obj[field] = obj.value;
        obj.selected = false;
        obj.selectable = false;
        return this.attributes = obj;
      };

      return FPObject;

    })(Backbone.Model));
  });

  scope("intermine.query.results", function(exporting) {
    var CompactView, DashBoard;
    exporting(DashBoard = (function(_super) {

      __extends(DashBoard, _super);

      function DashBoard() {
        return DashBoard.__super__.constructor.apply(this, arguments);
      }

      DashBoard.prototype.tagName = "div";

      DashBoard.prototype.className = "query-display row-fluid";

      DashBoard.prototype.initialize = function(service, query, queryEvents, tableProperties) {
        var _ref;
        this.query = query;
        this.queryEvents = queryEvents;
        this.tableProperties = tableProperties;
        console.log(this.tableProperties);
        if ((_ref = this.events) == null) {
          this.events = {};
        }
        if (_(service).isString()) {
          return this.service = new intermine.Service({
            root: service
          });
        } else if (service.fetchModel) {
          return this.service = service;
        } else {
          return this.service = new intermine.Service(service);
        }
      };

      DashBoard.prototype.TABLE_CLASSES = "span9 im-query-results";

      DashBoard.prototype.render = function() {
        var promise,
          _this = this;
        this.$el.addClass("bootstrap");
        promise = this.service.query(this.query, function(q) {
          var cb, evt, k, main, v, _ref, _ref1, _results;
          main = _this.make("div", {
            "class": _this.TABLE_CLASSES
          });
          _this.$el.append(main);
          _this.table = new intermine.query.results.Table(q, main);
          _ref = _this.tableProperties;
          for (k in _ref) {
            v = _ref[k];
            _this.table[k] = v;
          }
          _this.table.render();
          _this.renderTools(q);
          _ref1 = _this.queryEvents;
          _results = [];
          for (evt in _ref1) {
            cb = _ref1[evt];
            _results.push(q.on(evt, cb));
          }
          return _results;
        });
        promise.fail(function(xhr, err, msg) {
          return _this.$el.append("<div class=\"alert alert-error\">\n    <h1>" + err + "</h1>\n    <p>Unable to construct query: " + msg + "</p>\n</div>");
        });
        return this;
      };

      DashBoard.prototype.renderTools = function(q) {
        var toolbar, tools;
        tools = this.make("div", {
          "class": "span3 im-query-toolbox"
        });
        this.$el.append(tools);
        toolbar = new intermine.query.tools.Tools(q);
        return toolbar.render().$el.appendTo(tools);
      };

      return DashBoard;

    })(Backbone.View));
    return exporting(CompactView = (function(_super) {

      __extends(CompactView, _super);

      function CompactView() {
        return CompactView.__super__.constructor.apply(this, arguments);
      }

      CompactView.prototype.className = "im-query-display compact";

      CompactView.prototype.TABLE_CLASSES = "im-query-results";

      CompactView.prototype.renderTools = function(q) {
        var toolbar;
        toolbar = new intermine.query.tools.ToolBar(q);
        return toolbar.render().$el.prependTo(this.el);
      };

      return CompactView;

    })(DashBoard));
  });

  scope("intermine.query.results.table", function(exporting) {
    var ColumnOrderer, OuterJoinGroup;
    OuterJoinGroup = (function(_super) {

      __extends(OuterJoinGroup, _super);

      function OuterJoinGroup() {
        return OuterJoinGroup.__super__.constructor.apply(this, arguments);
      }

      OuterJoinGroup.prototype.tagName = 'li';

      OuterJoinGroup.prototype.className = 'im-reorderable breadcrumb';

      OuterJoinGroup.prototype.initialize = function(query, ojg, views, indices) {
        this.query = query;
        this.ojg = ojg;
        this.views = views;
        this.indices = indices;
      };

      OuterJoinGroup.prototype.render = function() {
        var h4, ul, v, _fn, _i, _len, _ref,
          _this = this;
        this.$el.append('<i class=icon-move></i>');
        h4 = $('<h4>');
        this.$el.append(h4);
        this.ojg.getDisplayName(function(name) {
          return h4.text(name);
        });
        this.$el.data('indices', this.indices);
        this.$el.data('path', this.ojg.toString());
        ul = $('<ul>');
        _ref = this.views;
        _fn = function(v) {
          var li;
          li = $('<li class="im-outer-joined-path">');
          ul.append(li);
          return _this.query.getPathInfo(v).getDisplayName(function(name) {
            return _this.ojg.getDisplayName(function(ojname) {
              return li.text(name.replace(ojname, '').replace(/^\s*>?\s*/, ''));
            });
          });
        };
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          v = _ref[_i];
          _fn(v);
        }
        this.$el.append(ul);
        return this;
      };

      return OuterJoinGroup;

    })(Backbone.View);
    return exporting(ColumnOrderer = (function(_super) {

      __extends(ColumnOrderer, _super);

      function ColumnOrderer() {
        this.initSorting = __bind(this.initSorting, this);
        return ColumnOrderer.__super__.constructor.apply(this, arguments);
      }

      ColumnOrderer.prototype.initialize = function(query) {
        this.query = query;
        return this.query.on("change:sortorder", this.initSorting);
      };

      ColumnOrderer.prototype.template = _.template("<a class=\"btn btn-large im-reorderer\">\n    <i class=\"icon-move\"></i>\n    Manage Columns\n</a>\n<div class=\"modal fade im-col-order-dialog\">\n    <div class=\"modal-header\">\n        <a class=\"close\" data-dismiss=\"modal\">close</a>\n        <h3>Manage Columns</a>\n    </div>\n    <div class=\"modal-body\">\n        <ul class=\"nav nav-tabs\">\n            <li class=\"active\"><a data-target=\".im-reordering\" data-toggle=\"tab\">Re-Order Columns</a></li>\n            <li><a data-target=\".im-sorting\" data-toggle=\"tab\">Re-Sort Columns</a></li>\n        </ul>\n        <div class=\"tab-content\">\n            <div class=\"tab-pane fade im-reordering active in\">\n                <ul class=\"im-reordering-container well\"></ul>\n            </div>\n            <div class=\"tab-pane fade im-sorting\">\n                <ul class=\"im-sorting-container well\"></ul>\n                <ul class=\"im-sorting-container-possibilities well\"></ul>\n            </div>\n        </div>\n    </div>\n    <div class=\"modal-footer\">\n        <a class=\"btn btn-cancel\">\n            Cancel\n        </a>\n        <a class=\"btn pull-right btn-primary\">\n            Apply\n        </a>\n    </div>\n</div>");

      ColumnOrderer.prototype.viewTemplate = _.template("<li class=\"im-reorderable breadcrumb\" data-col-idx=\"<%= idx %>\" data-path=\"<%- path %>\">\n    <i class=\"icon-move\"></i>\n    <h4 class=\"im-display-name\"><%- displayName %></span>\n</li>");

      ColumnOrderer.prototype.render = function() {
        var colContainer,
          _this = this;
        this.$el.append(this.template());
        colContainer = this.initOrdering();
        colContainer.sortable();
        this.initSorting();
        this.$('.nav-tabs li a').each(function(i, e) {
          var $elem;
          $elem = $(e);
          return $elem.data({
            target: _this.$($elem.data("target"))
          });
        });
        this.$('.modal').modal({
          show: false
        });
        return this;
      };

      ColumnOrderer.prototype.events = {
        'click a.im-reorderer': 'showModal',
        'click .btn-cancel': 'hideModel',
        'click .btn-primary': 'applyChanges',
        'click .nav-tabs li a': 'changeTab',
        'click .im-soe i.im-remove-soe': 'removeSortOrder',
        'click .im-add-soe': 'addSortOrder',
        'click .im-sort-direction': 'sortCol'
      };

      ColumnOrderer.prototype.changeTab = function(e) {
        return $(e.target).tab("show");
      };

      ColumnOrderer.prototype.initOrdering = function() {
        var colContainer, i, processed, v, _fn, _i, _len, _ref,
          _this = this;
        colContainer = this.$('.im-reordering-container');
        colContainer.empty();
        processed = {};
        _ref = this.query.views;
        _fn = function(v, i) {
          var indices, moveableView, oj, pi, vandi, views, x;
          if (_this.query.isOuterJoined(v)) {
            pi = _this.query.getPathInfo(v);
            oj = _this.query.joins[pi.toString()] === 'OUTER' ? pi : null;
            while (!(pi != null ? pi.isRoot() : void 0)) {
              pi = pi.getParent();
              oj = _this.query.joins[pi.toString()] === 'OUTER' ? pi : oj;
            }
            if (!processed[oj.toString()]) {
              vandi = (function() {
                var _j, _len1, _ref1, _results;
                _ref1 = this.query.views;
                _results = [];
                for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
                  v = _ref1[i];
                  if (v.match(oj.toString())) {
                    _results.push([v, i]);
                  }
                }
                return _results;
              }).call(_this);
              views = (function() {
                var _j, _len1, _results;
                _results = [];
                for (_j = 0, _len1 = vandi.length; _j < _len1; _j++) {
                  x = vandi[_j];
                  _results.push(x[0]);
                }
                return _results;
              })();
              indices = (function() {
                var _j, _len1, _results;
                _results = [];
                for (_j = 0, _len1 = vandi.length; _j < _len1; _j++) {
                  x = vandi[_j];
                  _results.push(x[1]);
                }
                return _results;
              })();
              moveableView = new OuterJoinGroup(_this.query, oj, views, indices).render().el;
              processed[oj.toString()] = true;
            }
          } else {
            moveableView = $(_this.viewTemplate({
              idx: i,
              displayName: v,
              path: v
            }));
            _this.query.getPathInfo(v).getDisplayName(function(name) {
              return moveableView.find('.im-display-name').text(name);
            });
          }
          return colContainer.append(moveableView);
        };
        for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
          v = _ref[i];
          _fn(v, i);
        }
        return colContainer;
      };

      ColumnOrderer.prototype.sortCol = function(e) {
        var $elem, newDirection;
        $elem = $(e.target).parent();
        newDirection = $elem.data("direction") === "ASC" ? "DESC" : "ASC";
        $elem.data({
          direction: newDirection
        });
        return $(e.target).toggleClass("asc desc");
      };

      ColumnOrderer.prototype.soTemplate = _.template("<li class=\"im-reorderable breadcrumb im-soe\" \n    data-path=\"<%- path %>\" data-direction=\"<%- direction %>\">\n    <% if (direction === 'ASC') { %>\n        <span class=\"im-sort-direction asc\"></span>\n    <% } else { %>\n        <span class=\"im-sort-direction desc\"></span>\n    <% } %>\n    <%- path %>\n    <i class=\"icon-minus pull-right im-remove-soe\" title=\"Remove this column from the sort order\"></i>\n</li>");

      ColumnOrderer.prototype.possibleSortOptionTemplate = _.template("<li class=\"im-reorderable breadcrumb\" data-path=\"<%- path %>\">\n    <%- path %>\n    <i class=\"icon-plus pull-right im-add-soe\" title=\"Add this column to the sort order\"></i>\n</li>");

      ColumnOrderer.prototype.removeSortOrder = function(e) {
        var $elem, path, possibilities, psoe;
        $elem = $(e.target).parent();
        path = $elem.data("path");
        $elem.find('.im-remove-soe').tooltip("hide");
        $elem.remove();
        possibilities = this.$('.im-sorting-container-possibilities');
        psoe = $(this.possibleSortOptionTemplate({
          path: path
        }));
        psoe.draggable({
          revert: "invalid",
          revertDuration: 100
        });
        psoe.find(".im-add-soe").tooltip();
        return possibilities.append(psoe);
      };

      ColumnOrderer.prototype.addSortOrder = function(e) {
        var $elem, path;
        $elem = $(e.target).parent();
        path = $elem.data("path");
        $elem.find('.im-add-soe').tooltip('hide');
        $elem.remove();
        return this.$('.im-sorting-container').append(this.makeSortOrderElem({
          path: path,
          direction: "ASC"
        }));
      };

      ColumnOrderer.prototype.sortingPlaceholder = "<div class=\"placeholder\">\n    Drop columns here.\n</div>";

      ColumnOrderer.prototype.makeSortOrderElem = function(so) {
        var soe, _ref;
        soe = $(this.soTemplate(so));
        if (_ref = this.query.getPathInfo(so.path).getType(), __indexOf.call(intermine.Model.NUMERIC_TYPES, _ref) >= 0) {
          soe.addClass("numeric");
        }
        soe.find('.im-remove-soe').tooltip();
        return soe;
      };

      ColumnOrderer.prototype.initSorting = function() {
        var cn, container, i, n, possibilities, so, v, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1, _ref2, _ref3, _ref4,
          _this = this;
        container = this.$('.im-sorting-container');
        container.empty().append(this.sortingPlaceholder);
        _ref = this.query.sortOrder || [];
        for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
          so = _ref[i];
          container.append(this.makeSortOrderElem(so));
        }
        possibilities = this.$('.im-sorting-container-possibilities');
        possibilities.empty();
        _ref1 = this.query.views;
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          v = _ref1[_j];
          if (!this.query.getSortDirection(v) && !this.query.isOuterJoined(v)) {
            possibilities.append(this.possibleSortOptionTemplate({
              path: v
            }));
          }
        }
        _ref2 = this.query.getQueryNodes();
        for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
          n = _ref2[_k];
          if (!this.query.isOuterJoined(n.toPathString())) {
            _ref3 = n.getChildNodes();
            for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {
              cn = _ref3[_l];
              if (cn.isAttribute() && (_ref4 = cn.toPathString(), __indexOf.call(this.query.views, _ref4) < 0)) {
                possibilities.append(this.possibleSortOptionTemplate({
                  path: cn.toPathString()
                }));
              }
            }
          }
        }
        possibilities.find("li").draggable({
          revert: "invalid",
          revertDuration: 100
        });
        possibilities.find(".im-add-soe").tooltip();
        return container.sortable().droppable({
          drop: function(event, ui) {
            var path;
            path = $(ui.draggable).data("path");
            $(ui.draggable).remove();
            return container.append(_this.makeSortOrderElem({
              path: path,
              direction: "ASC"
            }));
          }
        });
      };

      ColumnOrderer.prototype.hideModel = function() {
        this.$('.modal').modal('hide');
        this.initOrdering();
        return this.initSorting();
      };

      ColumnOrderer.prototype.showModal = function() {
        return this.$('.modal').modal('show');
      };

      ColumnOrderer.prototype.applyChanges = function(e) {
        if (this.$('.im-reordering').is('.active')) {
          return this.changeOrder(e);
        } else {
          return this.changeSorting(e);
        }
      };

      ColumnOrderer.prototype.changeOrder = function(e) {
        var lis, newViews, p, paths, pi, v, _i, _j, _len, _len1, _ref;
        lis = this.$('.im-reordering-container li');
        paths = lis.map(function(i, e) {
          return $(e).data('path');
        }).get();
        newViews = [];
        for (_i = 0, _len = paths.length; _i < _len; _i++) {
          p = paths[_i];
          pi = this.query.getPathInfo(p);
          if (pi.isAttribute()) {
            newViews.push(p);
          } else {
            _ref = this.query.views;
            for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
              v = _ref[_j];
              if (v.match(p)) {
                newViews.push(v);
              }
            }
          }
        }
        this.$('.modal').modal('hide');
        return this.query.select(newViews);
      };

      ColumnOrderer.prototype.changeSorting = function(e) {
        var lis, newSO;
        lis = this.$('.im-sorting-container li');
        newSO = lis.map(function(i, e) {
          return {
            path: $(e).data('path'),
            direction: $(e).data("direction")
          };
        }).get();
        this.$('.modal').modal('hide');
        return this.query.orderBy(newSO);
      };

      return ColumnOrderer;

    })(Backbone.View));
  });

  scope("intermine.results", function(exporting) {
    var BooleanFacet, ColumnSummary, FACET_TEMPLATE, FACET_TITLE, FacetRow, FacetView, FrequencyFacet, HistoFacet, MORE_FACETS_HTML, NormalCurve, NumericFacet, PieFacet;
    NormalCurve = function(mean, stdev) {
      return function(x) {
        var a;
        a = x - mean;
        return Math.exp(-(a * a) / (2 * stdev * stdev)) / (Math.sqrt(2 * Math.PI) * stdev);
      };
    };
    MORE_FACETS_HTML = "<i class=\"icon-plus-sign pull-right\" title=\"Showing top ten. Click to see all values\"></i>";
    FACET_TITLE = _.template("<dt><i class=\"icon-chevron-right\"></i><%= title %></dt>");
    FACET_TEMPLATE = _.template("<dd>\n    <a href=#>\n        <b class=\"im-facet-count pull-right\">\n            (<%= count %>)\n        </b>\n        <%= item %>\n    </a>\n</dd>");
    exporting(ColumnSummary = (function(_super) {

      __extends(ColumnSummary, _super);

      function ColumnSummary() {
        this.render = __bind(this.render, this);
        return ColumnSummary.__super__.constructor.apply(this, arguments);
      }

      ColumnSummary.prototype.tagName = 'div';

      ColumnSummary.prototype.className = "im-column-summary";

      ColumnSummary.prototype.initialize = function(facet, query) {
        this.query = query;
        if (_(facet).isString()) {
          return this.facet = {
            path: facet,
            title: facet.replace(/^[^\.]+\./, "").replace(/\./g, " > "),
            ignoreTitle: true
          };
        } else {
          return this.facet = facet;
        }
      };

      ColumnSummary.prototype.render = function() {
        var attrType, clazz, fac, initialLimit;
        attrType = this.query.getPathInfo(this.facet.path).getType();
        if (__indexOf.call(intermine.Model.NUMERIC_TYPES, attrType) >= 0) {
          clazz = NumericFacet;
        } else if (__indexOf.call(intermine.Model.BOOLEAN_TYPES, attrType) >= 0) {
          clazz = BooleanFacet;
        } else {
          clazz = FrequencyFacet;
        }
        initialLimit = 400;
        fac = new clazz(this.query, this.facet, initialLimit, this.noTitle);
        this.$el.append(fac.el);
        fac.render();
        return this;
      };

      return ColumnSummary;

    })(Backbone.View));
    exporting(FacetView = (function(_super) {

      __extends(FacetView, _super);

      function FacetView() {
        this.render = __bind(this.render, this);
        return FacetView.__super__.constructor.apply(this, arguments);
      }

      FacetView.prototype.tagName = "dl";

      FacetView.prototype.initialize = function(query, facet, limit, noTitle) {
        this.query = query;
        this.facet = facet;
        this.limit = limit;
        this.noTitle = noTitle;
        this.query.on("change:constraints", this.render);
        return this.query.on("filter:summary", this.render);
      };

      FacetView.prototype.render = function() {
        var _this = this;
        this.$dt = $(FACET_TITLE(this.facet)).appendTo(this.el);
        this.$dt.click(function() {
          _this.$dt.siblings().slideToggle();
          return _this.$dt.find('i').first().toggleClass('icon-chevron-right icon-chevron-down');
        });
        return this;
      };

      return FacetView;

    })(Backbone.View));
    exporting(FrequencyFacet = (function(_super) {

      __extends(FrequencyFacet, _super);

      function FrequencyFacet() {
        this.addItem = __bind(this.addItem, this);
        return FrequencyFacet.__super__.constructor.apply(this, arguments);
      }

      FrequencyFacet.prototype.render = function(filterTerm) {
        var $progress, promise,
          _this = this;
        if (filterTerm == null) {
          filterTerm = "";
        }
        if (this.rendering) {
          return;
        }
        this.rendering = true;
        this.$el.empty();
        if (!this.noTitle) {
          FrequencyFacet.__super__.render.call(this);
        }
        $progress = $("<div class=\"progress progress-info progress-striped active\">\n    <div class=\"bar\" style=\"width:100%\"></div>\n</div>");
        $progress.appendTo(this.el);
        promise = this.query.filterSummary(this.facet.path, filterTerm, this.limit, function(items, total, filteredTotal) {
          var hasMore, hf, more, pf, _ref;
          _this.query.trigger("got:summary:total", _this.facet.path, total, items.length, filteredTotal);
          $progress.remove();
          if ((_ref = _this.$dt) != null) {
            _ref.append(" (" + total + ")");
          }
          hasMore = items.length < _this.limit ? false : total > _this.limit;
          if (hasMore) {
            more = $(MORE_FACETS_HTML).appendTo(_this.$dt).tooltip({
              placement: "left"
            }).click(function(e) {
              var got, show;
              e.stopPropagation();
              got = _this.$('dd').length;
              show = _this.$('dd').first().is(':visible');
              _this.query.summarise(_this.facet.path, function(items) {
                var item, _i, _len, _ref1, _results;
                _ref1 = items.slice(got);
                _results = [];
                for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
                  item = _ref1[_i];
                  _results.push((_this.addItem(item)).toggle(show));
                }
                return _results;
              });
              return more.tooltip('hide').remove();
            });
          }
          if (total <= 12 && !_this.query.canHaveMultipleValues(_this.facet.path)) {
            pf = new PieFacet(_this.query, _this.facet, items, hasMore, filterTerm);
            _this.$el.append(pf.el);
            pf.render();
          } else {
            hf = new HistoFacet(_this.query, _this.facet, items, hasMore, filterTerm);
            _this.$el.append(hf.el);
            hf.render();
          }
          if (total <= 1) {
            _this.$el.empty();
          }
          return _this.rendering = false;
        });
        promise.fail(this.remove);
        return this;
      };

      FrequencyFacet.prototype.addItem = function(item) {
        var $dd,
          _this = this;
        $dd = $(FACET_TEMPLATE(item)).appendTo(this.el);
        $dd.click(function() {
          return _this.query.addConstraint({
            title: _this.facet.title,
            path: _this.facet.path,
            op: "=",
            value: item.item
          });
        });
        return $dd;
      };

      return FrequencyFacet;

    })(FacetView));
    exporting(NumericFacet = (function(_super) {

      __extends(NumericFacet, _super);

      function NumericFacet() {
        this.drawCurve = __bind(this.drawCurve, this);

        this.drawChart = __bind(this.drawChart, this);

        this.drawSlider = __bind(this.drawSlider, this);

        this.drawStats = __bind(this.drawStats, this);

        this.handleSummary = __bind(this.handleSummary, this);
        return NumericFacet.__super__.constructor.apply(this, arguments);
      }

      NumericFacet.prototype.events = {
        'click': function(e) {
          return e.stopPropagation();
        }
      };

      NumericFacet.prototype.className = "im-numeric-facet";

      NumericFacet.prototype.render = function() {
        var canvas, promise;
        NumericFacet.__super__.render.call(this);
        this.container = this.make("div", {
          "class": "facet-content im-facet"
        });
        this.$el.append(this.container);
        canvas = this.make("div");
        $(this.container).append(canvas);
        this.paper = Raphael(canvas, this.$el.width(), 75);
        promise = this.query.summarise(this.facet.path, this.handleSummary);
        promise.fail(this.remove);
        return this;
      };

      NumericFacet.prototype.handleSummary = function(items) {
        var summary;
        summary = items[0];
        this.mean = parseFloat(summary.average);
        this.dev = parseFloat(summary.stdev);
        this.max = summary.max;
        this.min = summary.min;
        if (summary.count != null) {
          this.drawChart(items);
        } else {
          this.drawCurve();
        }
        this.drawStats();
        return this.drawSlider();
      };

      NumericFacet.prototype.drawStats = function() {
        return $(this.container).append("<table class=\"table table-bordered table-condensed\">\n    <thead>\n        <tr>\n            <th>Min</th>\n            <th>Max</th>\n            <th>Mean</th>\n            <th>Standard Deviation</th>\n        </tr>\n    </thead>\n    <tbody>\n        <tr>\n            <td>" + this.min + "</td>\n            <td>" + this.max + "</td>\n            <td>" + (this.mean.toFixed(5)) + "</td>\n            <td>" + (this.dev.toFixed(5)) + "</td>\n        </tr>\n    </tbody>\n</table>");
      };

      NumericFacet.prototype.drawSlider = function() {
        var $slider, step, _ref,
          _this = this;
        $(this.container).append("<label>Range:</label>\n<input type=\"text\" class=\"im-range-min input\" value=\"" + this.min + "\">\n<span>...</span>\n<input type=\"text\" class=\"im-range-max input\" value=\"" + this.max + "\">\n<button class=\"btn btn-primary disabled\">Apply</button>\n<button class=\"btn btn-cancel disabled\">Reset</button>\n<div class=\"slider\"></div>");
        step = (_ref = this.query.getType(this.facet.path)) === "int" || _ref === "Integer" ? 1 : 0.1;
        $slider = this.$('.slider').slider({
          range: true,
          min: this.min,
          max: this.max,
          values: [this.min, this.max],
          step: step,
          slide: function(e, ui) {
            var changed;
            changed = ui.values[0] > _this.min || ui.values[1] < _this.max;
            _this.$('.btn').toggleClass("disabled", !changed);
            _this.$('input.im-range-min').val(ui.values[0]);
            return _this.$('input.im-range-max').val(ui.values[1]);
          }
        });
        this.$('.btn-cancel').click(function() {
          $slider.slider('values', 0, _this.min);
          $slider.slider('values', 1, _this.max);
          _this.$('input.im-range-min').val(_this.min);
          _this.$('input.im-range-max').val(_this.max);
          return _this.$('.btn').addClass("disabled");
        });
        return this.$('.btn-primary').click(function() {
          _this.query.constraints = _(_this.query.constraints).filter(function(c) {
            return c.path !== _this.facet.path;
          });
          return _this.query.addConstraints([
            {
              path: _this.facet.path,
              op: ">=",
              value: _this.$('input.im-range-min').val()
            }, {
              path: _this.facet.path,
              op: "<=",
              value: _this.$('input.im-range-max').val()
            }
          ]);
        });
      };

      NumericFacet.prototype.drawChart = function(items) {
        var acceptableGap, baseLine, curX, fixity, gap, h, hh, i, item, lastX, leftMargin, max, p, stepWidth, tick, topMargin, val, w, xtick, yaxis, _fn, _fn1, _fn2, _i, _j, _k, _l, _len, _len1, _ref, _ref1,
          _this = this;
        h = 75;
        hh = h * 0.7;
        max = _.max(_.pluck(items, "count"));
        w = this.$el.closest(':visible').width() * 0.95;
        acceptableGap = w / 15;
        p = this.paper;
        gap = 0;
        topMargin = h * 0.1;
        leftMargin = 20;
        stepWidth = (w - (leftMargin + 1)) / items[0].buckets;
        baseLine = hh + topMargin;
        _fn = function(tick) {
          var line;
          line = p.path("M" + (leftMargin - 4) + "," + (baseLine - (hh / 10 * tick)) + " h" + (w - gap));
          return line.node.setAttribute("class", "tickline");
        };
        for (tick = _i = 0; _i <= 10; tick = ++_i) {
          _fn(tick);
        }
        yaxis = this.paper.path("M" + (leftMargin - 4) + ", " + baseLine + " v-" + hh);
        yaxis.node.setAttribute("class", "yaxis");
        _ref = [0, 5, 10];
        _fn1 = function(tick) {
          var t, val, ypos;
          ypos = baseLine - (hh / 10 * tick);
          val = max / 10 * tick;
          t = _this.paper.text(leftMargin - 6, ypos, val.toFixed()).attr({
            "text-anchor": "end",
            "font-size": "10px"
          });
          if ($.browser.webkit) {
            if (!_this.$el.offsetParent().filter(function() {
              return $(this).css("position") === "absolute";
            }).length) {
              return t.translate(0, -ypos);
            }
          }
        };
        for (_j = 0, _len = _ref.length; _j < _len; _j++) {
          tick = _ref[_j];
          _fn1(tick);
        }
        _fn2 = function(item, i) {
          var path, pathCmd, prop;
          prop = item.count / max;
          pathCmd = "M" + ((item.bucket - 1) * stepWidth + leftMargin) + "," + baseLine + " v-" + (hh * prop) + " h" + (stepWidth - gap) + " v" + (hh * prop) + " z";
          return path = _this.paper.path(pathCmd);
        };
        for (i = _k = 0, _len1 = items.length; _k < _len1; i = ++_k) {
          item = items[i];
          _fn2(item, i);
        }
        item = items[0];
        fixity = item.max - item.min > 5 ? 0 : 2;
        lastX = 0;
        for (xtick = _l = 0, _ref1 = item.buckets; 0 <= _ref1 ? _l <= _ref1 : _l >= _ref1; xtick = 0 <= _ref1 ? ++_l : --_l) {
          curX = xtick * stepWidth + leftMargin;
          if (lastX === 0 || curX - lastX >= acceptableGap || xtick === item.buckets) {
            lastX = curX;
            val = item.min + (xtick * ((item.max - item.min) / item.buckets));
            this.paper.text(curX, baseLine + 5, val.toFixed(fixity));
          }
        }
        return this;
      };

      NumericFacet.prototype.drawCurve = function() {
        var drawDivider, f, factor, getPathCmd, h, invert, nc, pathCmd, points, scale, sections, stdevs, w, x, xs, _i, _j, _ref, _results, _results1,
          _this = this;
        if (this.max === this.min) {
          $(this.el).remove();
          return;
        }
        sections = ((this.max - this.min) / this.dev).toFixed();
        w = this.$el.width();
        h = 75;
        nc = NormalCurve(w / 2, w / sections);
        factor = h / nc(w / 2);
        invert = function(x) {
          return h - x + 2;
        };
        scale = function(x) {
          return x * factor;
        };
        f = _.compose(invert, scale, nc);
        xs = (function() {
          _results = [];
          for (var _i = 1; 1 <= w ? _i <= w : _i >= w; 1 <= w ? _i++ : _i--){ _results.push(_i); }
          return _results;
        }).apply(this);
        points = _.zip(xs, (function() {
          var _j, _len, _results1;
          _results1 = [];
          for (_j = 0, _len = xs.length; _j < _len; _j++) {
            x = xs[_j];
            _results1.push(f(x));
          }
          return _results1;
        })());
        pathCmd = "M1," + h + "S" + (points.join(",")) + "L" + (w - 1) + "," + h + "Z";
        this.paper.path(pathCmd);
        _results1 = [];
        for (stdevs = _j = 0, _ref = (sections / 2) + 1; 0 <= _ref ? _j <= _ref : _j >= _ref; stdevs = 0 <= _ref ? ++_j : --_j) {
          xs = _.uniq([w / 2 - (stdevs * w / sections), w / 2 + (stdevs * w / sections)]);
          getPathCmd = function(x) {
            return "M" + x + "," + h + "L" + x + "," + (f(x));
          };
          drawDivider = function(x) {
            return _this.paper.path(getPathCmd(x));
          };
          _results1.push((function() {
            var _k, _len, _results2;
            _results2 = [];
            for (_k = 0, _len = xs.length; _k < _len; _k++) {
              x = xs[_k];
              if ((0 <= x && x <= w)) {
                _results2.push(drawDivider(x));
              }
            }
            return _results2;
          })());
        }
        return _results1;
      };

      return NumericFacet;

    })(FacetView));
    exporting(PieFacet = (function(_super) {

      __extends(PieFacet, _super);

      function PieFacet() {
        return PieFacet.__super__.constructor.apply(this, arguments);
      }

      PieFacet.prototype.className = 'im-pie-facet im-facet';

      PieFacet.prototype.initialize = function(query, facet, items, hasMore, filterTerm) {
        var _ref,
          _this = this;
        this.query = query;
        this.facet = facet;
        this.hasMore = hasMore;
        this.filterTerm = filterTerm;
        this.items = new Backbone.Collection(items);
        this.items.each(function(item) {
          return item.set("visibility", true);
        });
        this.items.maxCount = (_ref = this.items.first()) != null ? _ref.get("count") : void 0;
        return this.items.on("change:selected", function() {
          var allAreSelected, someAreSelected;
          someAreSelected = _this.items.any(function(item) {
            return item.get("selected");
          });
          allAreSelected = !_this.items.any(function(item) {
            return !item.get("selected");
          });
          _this.$('.im-filter .btn').attr("disabled", !someAreSelected);
          return _this.$('.im-filter .btn-toggle-selection').attr("disabled", allAreSelected).toggleClass("im-invert", someAreSelected);
        });
      };

      PieFacet.prototype.events = {
        'click .im-filter .btn-primary': 'addConstraint',
        'click .im-filter .btn-cancel': 'resetOptions',
        'click .im-filter .btn-toggle-selection': 'toggleSelection',
        click: function(e) {
          e.stopPropagation();
          return e.preventDefault();
        }
      };

      PieFacet.prototype.resetOptions = function(e) {
        return this.items.each(function(item) {
          return item.set("selected", false);
        });
      };

      PieFacet.prototype.toggleSelection = function(e) {
        return this.items.each(function(item) {
          if (item.get("visibility")) {
            return item.set("selected", !item.get("selected"));
          }
        });
      };

      PieFacet.prototype.addConstraint = function(e) {
        var item, newCon;
        newCon = {
          path: this.facet.path,
          op: "ONE OF",
          values: (function() {
            var _i, _len, _ref, _results;
            _ref = this.items.filter(function(item) {
              return item.get("selected");
            });
            _results = [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              item = _ref[_i];
              _results.push(item.get("item"));
            }
            return _results;
          }).call(this)
        };
        if (!this.facet.ignoreTitle) {
          newCon.title = this.facet.title;
        }
        return this.query.addConstraint(newCon);
      };

      PieFacet.prototype.render = function() {
        return this.addChart().addControls();
      };

      PieFacet.GREEKS = "αβγδεζηθικλμνξορστυφχψω".split("");

      PieFacet.prototype.addChart = function() {
        var chart, cx, cy, degs, h, i, r, t, texts, total, w, _i, _len,
          _this = this;
        if (this.items.all(function(i) {
          return i.get("count") === 1;
        })) {
          return this;
        }
        h = 100;
        w = this.$el.closest(':visible').width();
        r = h * 0.8 / 2;
        chart = this.make("div");
        this.$el.append(chart);
        this.paper = Raphael(chart, w, h);
        cx = w / 2;
        cy = h / 2;
        total = this.items.reduce((function(a, b) {
          return a + b.get("count");
        }), 0);
        degs = 0;
        i = 0;
        texts = this.items.map(function(item) {
          var arc, cmd, dx, dy, path, prop, rads, t, textRads, textdx, textdy;
          prop = item.get("count") / total;
          item.set("percent", prop * 100);
          rads = 2 * Math.PI * prop;
          arc = prop > 0.5 ? 1 : 0;
          dy = r + (-r * Math.cos(rads));
          dx = r * Math.sin(rads);
          cmd = "M" + cx + "," + cy + " v-" + r + " a" + r + "," + r + " 0 " + arc + ",1 " + dx + "," + dy + " z";
          path = _this.paper.path(cmd);
          item.set("path", path);
          path.rotate(degs, cx, cy);
          textRads = (Raphael.rad(degs)) + (rads / 2);
          textdy = -(r * 0.6 * Math.cos(textRads));
          textdx = r * 0.6 * Math.sin(textRads);
          item.set("symbol", PieFacet.GREEKS[i++]);
          t = _this.paper.text(cx, cy, item.get("symbol"));
          t.attr({
            "font-size": "14px",
            "text-anchor": textdx > 0 ? "start" : "end"
          });
          t.translate(textdx, textdy);
          if ($.browser.webkit) {
            if (!_this.$el.offsetParent().filter(function() {
              return $(this).css("position") === "absolute";
            }).length) {
              t.translate(0, -(r * 1.5));
            }
          }
          t.node.setAttribute("class", "pie-label");
          degs += 360 * prop;
          return t;
        });
        for (_i = 0, _len = texts.length; _i < _len; _i++) {
          t = texts[_i];
          t.toFront();
        }
        return this;
      };

      PieFacet.prototype.addControls = function() {
        var $grp, $valFilter, facet, xs,
          _this = this;
        $grp = $("<form class=\"form form-horizontal\">\n    <div class=\"input-prepend\">\n        <span class=\"add-on\"><i class=\"icon-refresh\"></i></span><input type=\"text\" class=\"input-medium search-query filter-values\" placeholder=\"Filter values\">\n    </div>\n    <div class=\"im-item-table\">\n        <table class=\"table table-condensed\">\n            <thead>\n                <tr>" + this.columnHeaders + "</tr>\n            </thead>\n            <tbody class=\"scrollable\"></tbody>\n        </table>\n    </div>\n</form>").appendTo(this.el);
        $grp.button();
        this.items.each(function(item) {
          var r;
          r = _this.makeRow(item);
          return $grp.find('tbody').append(r);
        });
        $grp.append("<div class=\"im-filter btn-group\">\n    <button type=\"submit\" class=\"btn btn-primary\" disabled>Filter</button>\n    <button class=\"btn btn-cancel\" disabled>Reset</button>\n    <button class=\"btn btn-toggle-selection\"></button>\n</div>");
        xs = this.items;
        $valFilter = $grp.find(".filter-values");
        if (this.filterTerm) {
          $valFilter.val(this.filterTerm);
        }
        facet = this;
        $valFilter.keyup(function(e) {
          var pattern;
          if (facet.hasMore || (facet.filterTerm && $(this).val().length < facet.filterTerm.length)) {
            return _.delay((function() {
              return facet.query.trigger('filter:summary', $valFilter.val());
            }), 750);
          } else {
            pattern = new RegExp($(this).val(), "i");
            return xs.each(function(x) {
              return x.set("visibility", pattern.test(x.get("item")));
            });
          }
        });
        $valFilter.prev().click(function(e) {
          $(this).next().val(facet.filterTerm);
          return xs.each(function(x) {
            return x.set("visibility", true);
          });
        });
        return this;
      };

      PieFacet.prototype.columnHeaders = "<th class=\"im-selector-col\"></th>\n<th class=\"im-item-col\">Item</th>\n<th class=\"im-count-col\">Count</th>\n<th class=\"im-prop-count\"></th>";

      PieFacet.prototype.makeRow = function(item) {
        var row;
        row = new FacetRow(item, this.items);
        return row.render().$el;
      };

      return PieFacet;

    })(Backbone.View));
    exporting(FacetRow = (function(_super) {

      __extends(FacetRow, _super);

      function FacetRow() {
        return FacetRow.__super__.constructor.apply(this, arguments);
      }

      FacetRow.prototype.tagName = "tr";

      FacetRow.prototype.className = "im-facet-row";

      FacetRow.prototype.initialize = function(item, items) {
        var _this = this;
        this.item = item;
        this.items = items;
        this.item.on("change:selected", function() {
          var isSelected;
          isSelected = _this.item.get("selected");
          if (_this.item.get("path")) {
            item.get("path").node.setAttribute("class", isSelected ? "selected" : "");
          }
          _this.$el.toggleClass("active", isSelected);
          if (isSelected !== _this.$('input').attr("checked")) {
            return _this.$('input').attr("checked", isSelected);
          }
        });
        return this.item.on("change:visibility", function() {
          return _this.$el.toggle(_this.item.get("visibility"));
        });
      };

      FacetRow.prototype.events = {
        'click': 'handleClick',
        'change input': 'handleChange'
      };

      FacetRow.prototype.render = function() {
        var inputType, percent;
        inputType = this.items.size() > 2 ? "checkbox" : "radio";
        percent = (parseInt(this.item.get("count")) / this.items.maxCount * 100).toFixed();
        this.$el.append("<td class=\"im-selector-col\">\n    <span>" + ((this.item.get("symbol")) || "") + "</span>\n    <input type=\"" + inputType + "\">\n</td>\n<td class=\"im-item-col\">" + (this.item.get("item")) + "</td>\n<td class=\"im-count-col\">\n    <div class=\"im-facet-bar\" style=\"width:" + percent + "%\">\n        " + (this.item.get("count")) + "\n    </div>\n</td>");
        if (this.item.get("percent")) {
          this.$el.append("<td class=\"im-prop-col\"><i>" + (this.item.get("percent").toFixed()) + "%</i></td>");
        }
        return this;
      };

      FacetRow.prototype.handleClick = function(e) {
        e.stopPropagation();
        if (e.target.type !== 'checkbox') {
          return this.$('input').trigger("click");
        }
      };

      FacetRow.prototype.handleChange = function(e) {
        e.preventDefault();
        return this.item.set("selected", this.$('input').attr('checked'));
      };

      return FacetRow;

    })(Backbone.View));
    exporting(HistoFacet = (function(_super) {

      __extends(HistoFacet, _super);

      function HistoFacet() {
        return HistoFacet.__super__.constructor.apply(this, arguments);
      }

      HistoFacet.prototype.columnHeaders = "<th></th>\n<th>Item</th>\n<th>Count</th>";

      HistoFacet.prototype.addChart = function() {
        var baseline, chart, f, gap, h, hh, leftMargin, max, p, stepWidth, tick, topMargin, w, yaxis, _fn, _fn1, _i, _j,
          _this = this;
        h = 75;
        hh = h * 0.8;
        w = this.$el.closest(':visible').width() * 0.95;
        f = this.items.first();
        max = f.get("count");
        if (this.items.all(function(i) {
          return i.get("count") === 1;
        })) {
          return this;
        }
        chart = this.make("div");
        this.$el.append(chart);
        p = this.paper = Raphael(chart, w, h);
        gap = w * 0.01;
        topMargin = h * 0.1;
        leftMargin = 30;
        stepWidth = (w - (leftMargin + 1)) / this.items.size();
        baseline = hh + topMargin;
        _fn = function(tick) {
          var line;
          line = p.path("M" + (leftMargin - 4) + "," + (baseline - (hh / 10 * tick)) + " h" + (w - gap));
          return line.node.setAttribute("class", "tickline");
        };
        for (tick = _i = 0; _i <= 10; tick = ++_i) {
          _fn(tick);
        }
        yaxis = this.paper.path("M" + (leftMargin - 4) + "," + baseline + " v-" + hh);
        yaxis.node.setAttribute("class", "yaxis");
        _fn1 = function(tick) {
          var t, val, ypos;
          ypos = baseline - (hh / 10 * tick);
          val = max / 10 * tick;
          if (!(val % 1)) {
            t = _this.paper.text(leftMargin - 6, ypos, val.toFixed()).attr({
              "text-anchor": "end",
              "font-size": "10px"
            });
            if ($.browser.webkit) {
              if (!_this.$el.offsetParent().filter(function() {
                return $(this).css("position") === "absolute";
              }).length) {
                return t.translate(0, -ypos);
              }
            }
          }
        };
        for (tick = _j = 0; _j <= 10; tick = ++_j) {
          _fn1(tick);
        }
        this.items.each(function(item, i) {
          var path, pathCmd, prop;
          prop = item.get("count") / max;
          pathCmd = "M" + (i * stepWidth + leftMargin) + "," + baseline + " v-" + (hh * prop) + " h" + (stepWidth - gap) + " v" + (hh * prop) + " z";
          path = _this.paper.path(pathCmd);
          return item.set("path", path);
        });
        return this;
      };

      return HistoFacet;

    })(PieFacet));
    return exporting(BooleanFacet = (function(_super) {

      __extends(BooleanFacet, _super);

      function BooleanFacet() {
        this.drawControls = __bind(this.drawControls, this);

        this.drawChart = __bind(this.drawChart, this);

        this.handleSummary = __bind(this.handleSummary, this);
        return BooleanFacet.__super__.constructor.apply(this, arguments);
      }

      BooleanFacet.prototype.handleSummary = function(items) {
        var f, t, total;
        t = _(items).find(function(i) {
          return i.item === true;
        });
        f = _(items).find(function(i) {
          return i.item === false;
        });
        total = ((t != null ? t.count : void 0) || 0) + ((f != null ? f.count : void 0) || 0);
        this.drawChart(total, (f != null ? f.count : void 0) || 0);
        return this.drawControls(total, (f != null ? f.count : void 0) || 0);
      };

      BooleanFacet.prototype.drawChart = function(total, subtotal) {
        var cx, cy, degs, fprop, h, i, prop, r, t, texts, tprop, w, _i, _len;
        h = 75;
        w = this.$el.closest(':visible').width();
        r = h * 0.8 / 2;
        cx = w / 2;
        cy = h / 2;
        fprop = subtotal / total;
        tprop = 1 - fprop;
        if (fprop === 0 || fprop === 1) {
          this.paper.circle(cx, cy, r);
          t = this.paper.text(cx, cy, (fprop === 1 ? "false" : "true") + (" (" + total + ")"));
          t.attr({
            "font-size": "16px"
          });
          return this;
        }
        degs = 0;
        texts = (function() {
          var _i, _len, _ref, _results,
            _this = this;
          _ref = [fprop, tprop];
          _results = [];
          for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
            prop = _ref[i];
            _results.push((function(prop, i) {
              var arc, cmd, dx, dy, num, path, rads, textRads, textdx, textdy;
              rads = 2 * Math.PI * prop;
              arc = (0.5 < prop && prop < 1) ? 1 : 0;
              dy = r + (-r * Math.cos(rads));
              dx = r * Math.sin(rads);
              cmd = "M" + cx + "," + cy + " v-" + r + " a" + r + "," + r + " 0 " + arc + ",1 " + dx + "," + dy + " z";
              path = _this.paper.path(cmd);
              if (i === 0) {
                _this.fpath = path;
              } else {
                _this.tpath = path;
              }
              path.rotate(degs, cx, cy);
              textRads = (Raphael.rad(degs)) + (rads / 2);
              textdy = -(r * 1.1 * Math.cos(textRads));
              textdx = r * 1.1 * Math.sin(textRads);
              num = i === 0 ? subtotal : total - subtotal;
              t = _this.paper.text(cx, cy, "" + (i === 0 ? "false" : "true") + " (" + num + ")");
              t.attr({
                "font-size": "12px",
                "text-anchor": textdx > 0 ? "start" : "end"
              });
              t.translate(textdx, textdy);
              if ($.browser.webkit) {
                if (!_this.$el.offsetParent().filter(function() {
                  return $(this).css("position") === "absolute";
                }).length) {
                  t.translate(0, -(r * 1.5));
                }
              }
              degs += 360 * prop;
              return t;
            })(prop, i));
          }
          return _results;
        }).call(this);
        for (_i = 0, _len = texts.length; _i < _len; _i++) {
          t = texts[_i];
          t.toFront;
        }
        return this;
      };

      BooleanFacet.prototype.drawControls = function(total, trues) {
        var c, handleTheTruth,
          _this = this;
        if (!(this.fpath && this.tpath)) {
          return this;
        }
        c = $(this.container).append("<form class=\"form-inline\">\n    <div class=\"btn-group\" data-toggle=\"buttons-radio\">\n        <a href=\"#\" class=\"btn im-trues\">True</a>\n        <a href=\"#\" class=\"btn im-falses\">False</a>\n    </div>\n    <div class=\"pull-right im-filter\">\n        <button class=\"btn btn-primary disabled\">Filter</button>\n        <button class=\"btn btn-cancel disabled\">Reset</button>\n    </div>\n</form>");
        c.find('.btn-group').button().find('.btn').click(function(e) {
          return c.find('.im-filter .btn').removeClass("disabled");
        });
        c.find('.btn-cancel').click(function(e) {
          _this.tpath.node.setAttribute("class", "trues");
          _this.fpath.node.setAttribute("class", "falses");
          c.find('.im-filter .btn').addClass("disabled");
          return c.find('.btn').removeClass("active");
        });
        c.find('.btn-primary').click(function(e) {
          return _this.query.addConstraint({
            path: _this.facet.path,
            op: '=',
            value: c.find('.im-trues').is('.active') ? "true" : "false"
          });
        });
        handleTheTruth = function(selPath) {
          return function(e) {
            _this.tpath.node.setAttribute("class", "");
            _this.fpath.node.setAttribute("class", "");
            selPath.node.setAttribute("class", "selected");
            return $(e.target).button('toggle');
          };
        };
        c.find('.im-trues').click(handleTheTruth(this.tpath));
        return c.find('.im-falses').click(handleTheTruth(this.fpath));
      };

      return BooleanFacet;

    })(NumericFacet));
  });

  scope("intermine.query", function(exporting) {
    var ActiveConstraint, NewConstraint, PATH_SEGMENT_DIVIDER;
    PATH_SEGMENT_DIVIDER = "&rarr;";
    exporting(ActiveConstraint = (function(_super) {

      __extends(ActiveConstraint, _super);

      function ActiveConstraint() {
        return ActiveConstraint.__super__.constructor.apply(this, arguments);
      }

      ActiveConstraint.prototype.tagName = "form";

      ActiveConstraint.prototype.className = "form-inline im-constraint row-fluid";

      ActiveConstraint.prototype.initialize = function(query, con) {
        var _ref;
        this.query = query;
        this.con = con;
        this.pathInfo = this.query.getPathInfo(this.con.path);
        this.type = this.pathInfo.getEndClass();
        if (this.pathInfo.isClass()) {
          return this.ops = intermine.Query.REFERENCE_OPS;
        } else if (_ref = this.pathInfo.getType(), __indexOf.call(intermine.Model.BOOLEAN_TYPES, _ref) >= 0) {
          return this.ops = ["=", "!="];
        } else {
          return this.ops = intermine.Query.ATTRIBUTE_OPS;
        }
      };

      ActiveConstraint.prototype.events = {
        'change .im-ops': 'drawValueOptions',
        'click .icon-edit': 'toggleEditForm',
        'click .btn-cancel': 'hideEditForm',
        'click .btn-primary': 'editConstraint',
        'click .icon-remove-sign': 'removeConstraint',
        'submit': 'handleSubmit'
      };

      ActiveConstraint.prototype.handleSubmit = function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      };

      ActiveConstraint.prototype.toggleEditForm = function() {
        this.$('.im-con-overview').siblings().slideToggle(200);
        return this.$('.im-value-options').show();
      };

      ActiveConstraint.prototype.hideEditForm = function(e) {
        if (e != null) {
          e.preventDefault();
        }
        if (e != null) {
          e.stopPropagation();
        }
        return this.$('.im-con-overview').siblings().slideUp(200);
      };

      ActiveConstraint.prototype.editConstraint = function() {
        this.updateConstraint();
        return this.query.trigger("change:constraints");
      };

      ActiveConstraint.prototype.updateConstraint = function() {
        var con, op;
        op = this.$('.im-ops').val();
        con = {
          op: op
        };
        if (__indexOf.call(intermine.Query.MULTIVALUE_OPS, op) >= 0) {
          con.values = this.$('.im-constraint-options input[type="checkbox"]').filter(function() {
            return $(this).attr("checked");
          }).map(function() {
            return $(this).data('value');
          }).get();
        } else {
          con.value = this.$('.im-value-options').val();
        }
        return _.extend(this.con, con);
      };

      ActiveConstraint.prototype.removeConstraint = function() {
        return this.query.removeConstraint(this.con);
      };

      ActiveConstraint.prototype.addIcons = function($label) {
        $label.append("<i class=\"icon-remove-sign\"></i>");
        if (this.con.locked) {
          return $label.append("<i class=\"icon-lock\" title=\"this constraint is not editable\"></i>");
        } else {
          return $label.append("<i class=\"icon-edit\"></i>");
        }
      };

      ActiveConstraint.prototype.buttons = [
        {
          text: "Update",
          "class": "btn btn-primary"
        }, {
          text: "Cancel",
          "class": "btn btn-cancel"
        }
      ];

      ActiveConstraint.prototype.addButtons = function() {
        var btns, c, t, _fn, _i, _len, _ref, _ref1;
        btns = $("<div class=\"btn-group\">\n</div>");
        _ref = this.buttons;
        _fn = function() {
          return btns.append("<button class=\"" + c + "\">" + t + "</button>");
        };
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          _ref1 = _ref[_i], t = _ref1.text, c = _ref1["class"];
          _fn();
        }
        return this.$el.append(btns);
      };

      ActiveConstraint.prototype.getTitleParts = function() {
        if (this.con.title) {
          return [this.con.title];
        } else {
          return this.con.path.replace(/^[^\.]+\.?/, "").split(".");
        }
      };

      ActiveConstraint.prototype.getTitleOp = function() {
        return this.con.op || "is a";
      };

      ActiveConstraint.prototype.getTitleVal = function() {
        if (this.con.values) {
          return this.con.values.length + " values";
        } else {
          return this.con.value || this.con.type;
        }
      };

      ActiveConstraint.prototype.render = function() {
        var $label, $select, conDetails, fs, i, lis, lisB, op, p, parts, val;
        parts = this.getTitleParts();
        conDetails = [];
        if ((op = this.getTitleOp())) {
          conDetails.push(op);
        }
        if ((val = this.getTitleVal())) {
          conDetails.push(val);
        }
        lis = (function() {
          var _i, _len, _results;
          _results = [];
          for (i = _i = 0, _len = parts.length; _i < _len; i = ++_i) {
            p = parts[i];
            _results.push("<li class=\"" + (i + 1 === parts.length ? 'active' : '') + "\">" + p + "</li>");
          }
          return _results;
        })();
        lisB = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = conDetails.length; _i < _len; _i++) {
            p = conDetails[_i];
            _results.push("<li>" + p + "</li>");
          }
          return _results;
        })();
        $label = $("<label class=\"im-con-overview\">\n    <ul class=\"im-con-summary breadcrumb\">\n        " + (lis.join("<span class='divider'>" + PATH_SEGMENT_DIVIDER + "</span>")) + "\n        " + (lisB.join('&nbsp')) + "\n    </ul>\n</label>");
        this.$el.append($label);
        this.addIcons($label);
        fs = $("<fieldset class=\"im-constraint-options\"></fieldset>").appendTo(this.el);
        $select = $("<select class=\"span4 im-ops\"><option>" + this.con.op + "</option></select>");
        $select.appendTo(fs);
        _(this.ops).chain().without(this.con.op).each(function(op) {
          return $select.append("<option>" + op + "</select>");
        });
        this.drawValueOptions();
        this.addButtons();
        return this;
      };

      ActiveConstraint.prototype.drawValueOptions = function() {
        var $lists, $multiValues, fs, op, values, _ref,
          _this = this;
        this.$('.im-value-options').remove();
        fs = this.$('.im-constraint-options');
        op = this.$('.im-ops').val();
        if (_ref = this.pathInfo.getType(), __indexOf.call(intermine.Model.BOOLEAN_TYPES, _ref) >= 0) {
          fs.append("<div class=\"btn-group\" data-toggle=\"buttons-radio\">\n    <button class=\"btn " + (this.con.value === 'true' ? 'active' : '') + "\" data-value=\"true\">\n        true\n    </button>\n    <button class=\"btn " + (this.con.value === 'false' ? 'active' : '') + "\" data-value=\"false\">\n        false\n    </button>\n</div>\n<input class=\"im-value-options\" type=\"hidden\" value=\"" + this.con.value + "\">");
        } else if (__indexOf.call(intermine.Query.MULTIVALUE_OPS, op) >= 0) {
          values = this.con.values || [];
          $multiValues = $('<table class="table table-condensed im-value-options"></table>').appendTo(fs);
          _(values).each(function(v) {
            return $multiValues.append("<tr>\n    <td><input type=checkbox checked data-value=\"" + v + "\"></td>\n    <td>" + v + "</td>\n</tr>");
          });
        } else if (__indexOf.call(intermine.Query.LIST_OPS, op) >= 0) {
          $lists = $("<select class=\"im-value-options\"></select>").appendTo(fs);
          this.query.service.fetchLists(function(ls) {
            var selectables, sl, _i, _len;
            selectables = _(ls).filter(function(l) {
              return l.size && l.type === _this.type.name;
            });
            for (_i = 0, _len = selectables.length; _i < _len; _i++) {
              sl = selectables[_i];
              $lists.append("<option value=\"" + sl.name + "\">" + sl.name + " (" + sl.size + " " + sl.type + "s)</option>");
            }
            if (_this.con.value) {
              return $lists.val(_this.con.value);
            }
          });
        } else {
          fs.append("<input class=\"span7 im-constraint-value im-value-options\" type=\"text\" \n    value=\"" + (this.con.value || this.con.type) + "\">");
        }
        if (__indexOf.call(intermine.Query.TERNARY_OPS, op) >= 0) {
          return fs.append("<input type=\"text\" class=\"im-extra-value im-value-options\" placeholder=\"restricting to...\"\n    value=\"" + this.con.extraValue + "\"\n>");
        }
      };

      return ActiveConstraint;

    })(Backbone.View));
    return exporting(NewConstraint = (function(_super) {

      __extends(NewConstraint, _super);

      function NewConstraint() {
        return NewConstraint.__super__.constructor.apply(this, arguments);
      }

      NewConstraint.prototype.initialize = function(query, con) {
        this.query = query;
        this.con = con;
        NewConstraint.__super__.initialize.call(this, this.query, this.con);
        this.$el.addClass("new");
        this.buttons[0].text = "Apply";
        if (this.type) {
          return this.con.op = "LOOKUP";
        } else {
          return this.con.op = "=";
        }
      };

      NewConstraint.prototype.addIcons = function() {};

      NewConstraint.prototype.hideEditForm = function() {
        this.query.trigger("cancel:add-constraint");
        return this.remove();
      };

      NewConstraint.prototype.updateConstraint = function() {
        NewConstraint.__super__.updateConstraint.call(this);
        return this.query.addConstraint(this.con);
      };

      return NewConstraint;

    })(ActiveConstraint));
  });

}).call(this);
